name: æ ‹ä»”ä¸»é¢˜é€šç”¨ç¼–è¯‘å¹³å°

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'ç‰ˆæœ¬ç±»å‹'
        required: true
        default: 'stable'
        type: choice
        options:
        - stable
        - dev
  push:
    branches: [ main, master ]
    paths:
      - '.config'
  schedule:
    - cron: '0 2 * * 1'

env:
  REPO_URL: https://github.com/coolsnowwolf/lede
  REPO_BRANCH: master
  UPLOAD_FIRMWARE: true
  UPLOAD_RELEASE: true

jobs:
  build:
    runs-on: ubuntu-20.04
    timeout-minutes: 240

    steps:
    - name: æ£€æŸ¥ä»£ç å’Œé…ç½®æ–‡ä»¶
      uses: actions/checkout@v4
      with:
        path: repository

    - name: éªŒè¯é…ç½®æ–‡ä»¶
      run: |
        echo "=== éªŒè¯é…ç½®æ–‡ä»¶ ==="
        if [ ! -f "repository/.config" ]; then
          echo "âŒ é”™è¯¯ï¼šæœªæ‰¾åˆ° .config æ–‡ä»¶"
          exit 1
        fi
        echo "âœ… æ‰¾åˆ°é…ç½®æ–‡ä»¶"

    - name: åˆå§‹åŒ–ç¯å¢ƒ
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential asciidoc binutils bzip2 gawk gettext git libncurses5-dev libz-dev patch python2.7 python3 unzip zlib1g-dev lib32gcc-s1 libc6-dev-i386 subversion flex uglifyjs git-core gcc-multilib p7zip p7zip-full msmtp libssl-dev texinfo libglib2.0-dev xmlto qemu-utils upx libelf-dev autoconf automake libtool autopoint device-tree-compiler g++-multilib antlr3 gperf wget curl swig rsync
        sudo mkdir -p /mnt/openwrt
        sudo chown $USER:$GROUP /mnt/openwrt
        python2.7 --version
        echo "âœ… ç¯å¢ƒåˆå§‹åŒ–å®Œæˆ"

    - name: å…‹éš†Leanæºç 
      working-directory: /mnt/openwrt
      run: |
        echo "å…‹éš† Lean OpenWrt æºç ..."
        git clone $REPO_URL -b $REPO_BRANCH lede
        ln -sf /mnt/openwrt/lede $GITHUB_WORKSPACE/lede
        echo "âœ… æºç å…‹éš†å®Œæˆ"

    - name: æ›´æ–°è½¯ä»¶æº
      run: |
        cd lede
        ./scripts/feeds update -a
        ./scripts/feeds install -a
        echo "âœ… è½¯ä»¶æºæ›´æ–°å®Œæˆ"

    - name: éƒ¨ç½²æ ‹ä»”ä¸ªæ€§åŒ–è®¾ç½®
      run: |
        cd lede
        echo "å¼€å§‹éƒ¨ç½²æ ‹ä»”ä¸ªæ€§åŒ–è®¾ç½®..."
        
        mkdir -p package/lean/dongzhai-theme/luci-theme-dongzhai
        
        if [ -d "$GITHUB_WORKSPACE/repository/.github/themes/dongzhai" ]; then
          echo "å¤åˆ¶æ ‹ä»”ä¸»é¢˜æ–‡ä»¶..."
          cp -r $GITHUB_WORKSPACE/repository/.github/themes/dongzhai/* package/lean/dongzhai-theme/
        fi
        
        cat > package/lean/dongzhai-theme/luci-theme-dongzhai/Makefile << 'EOF'
include $(TOPDIR)/rules.mk

LUCI_TITLE:=æ ‹ä»”ä¸ªæ€§åŒ–ä¸»é¢˜
LUCI_DEPENDS:=
PKG_VERSION:=1.0
PKG_RELEASE:=1

include $(INCLUDE_DIR)/package.mk

define Package/luci-theme-dongzhai
  $(call Package/luci/webtemplate)
  TITLE:=æ ‹ä»”ä¸ªæ€§åŒ–ä¸»é¢˜
  DEPENDS:=+luci-compat
endef

define Package/luci-theme-dongzhai/description
  æ ‹ä»”ä¸ªæ€§åŒ–ä¸»é¢˜
endef

define Build/Configure
endef

define Build/Compile
endef

define Package/luci-theme-dongzhai/install
	$(INSTALL_DIR) $(1)/www/luci-static/dongzhai
	[ -d ./files ] && $(CP) ./files/* $(1)/www/luci-static/dongzhai/
endef

$(eval $(call BuildPackage,luci-theme-dongzhai))
EOF

        echo "âœ… æ ‹ä»”ä¸ªæ€§åŒ–è®¾ç½®éƒ¨ç½²å®Œæˆ"

    - name: åº”ç”¨é…ç½®å¹¶æ·»åŠ ä¸ªæ€§åŒ–è®¾ç½®
      run: |
        cd lede
        cp $GITHUB_WORKSPACE/repository/.config .config
        
        if ! grep -q "CONFIG_PACKAGE_luci-theme-dongzhai=y" .config; then
          echo "æ·»åŠ æ ‹ä»”ä¸»é¢˜é…ç½®..."
          echo "" >> .config
          echo "# æ ‹ä»”ä¸ªæ€§åŒ–ä¸»é¢˜é…ç½®" >> .config
          echo "CONFIG_PACKAGE_luci-theme-dongzhai=y" >> .config
        fi
        
        if grep -q "CONFIG_PACKAGE_luci=y" .config; then
          echo "è®¾ç½®æ ‹ä»”ä¸»é¢˜ä¸ºé»˜è®¤..."
          sed -i '/CONFIG_DEFAULT_luci-theme/d' .config
          echo "CONFIG_DEFAULT_luci-theme-dongzhai=y" >> .config
        fi
        
        make defconfig
        echo "âœ… é…ç½®åº”ç”¨å®Œæˆ"

    - name: ä¸‹è½½è½¯ä»¶åŒ…
      run: |
        cd lede
        echo "å¼€å§‹ä¸‹è½½è½¯ä»¶åŒ…..."
        make download -j$(nproc)
        echo "âœ… è½¯ä»¶åŒ…ä¸‹è½½å®Œæˆ"

    - name: ç¼–è¯‘å›ºä»¶
      run: |
        cd lede
        echo "å¼€å§‹ç¼–è¯‘..."
        echo "ä½¿ç”¨ $(($(nproc) / 2 + 1)) ä¸ªçº¿ç¨‹ç¼–è¯‘..."
        make -j$(($(nproc) / 2 + 1)) || make -j1 || make -j1 V=s
        echo "âœ… ç¼–è¯‘å®Œæˆ"

    - name: æ”¶é›†ç¼–è¯‘ç»“æœ
      id: collect_results
      run: |
        cd lede/bin/targets
        
        FIRMWARE_FILES=$(find . -name "*.bin" -type f)
        if [ -n "$FIRMWARE_FILES" ]; then
          echo "ğŸ‰ æ‰¾åˆ°ç¼–è¯‘è¾“å‡ºæ–‡ä»¶:"
          for file in $FIRMWARE_FILES; do
            if [ -f "$file" ]; then
              size=$(du -h "$file" | cut -f1)
              echo "  ğŸ“„ $file (å¤§å°: $size)"
            fi
          done
          
          FIRST_FILE=$(echo "$FIRMWARE_FILES" | head -1)
          DEVICE_PATH=$(dirname "$FIRMWARE_FILES")
          ARCH_INFO=$(echo "$FIRMWARE_FILES" | head -1 | grep -o 'targets/[^/]*/[^/]*' | cut -d'/' -f2-3 | tr '/' '_')
          
          echo "has_firmware=true" >> $GITHUB_OUTPUT
          echo "firmware_count=$(echo "$FIRMWARE_FILES" | wc -w)" >> $GITHUB_OUTPUT
          echo "device_arch=$ARCH_INFO" >> $GITHUB_ENV
        else
          echo "âŒ æœªæ‰¾åˆ°å›ºä»¶æ–‡ä»¶!"
          echo "has_firmware=false" >> $GITHUB_OUTPUT
        fi

    - name: ä¸Šä¼ å›ºä»¶åˆ°Artifacts
      uses: actions/upload-artifact@v4
      if: steps.collect_results.outputs.has_firmware == 'true'
      with:
        name: æ ‹ä»”å›ºä»¶_${{ env.device_arch }}_${{ github.event.inputs.version }}
        path: lede/bin/targets/**/*.bin
        retention-days: 30

    - name: åˆ›å»ºç‰ˆæœ¬å‘å¸ƒ
      if: steps.collect_results.outputs.has_firmware == 'true' && env.UPLOAD_RELEASE == 'true'
      uses: softprops/action-gh-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: dongzhai-${{ env.device_arch }}-${{ github.event.inputs.version }}-$(date +%Y%m%d)
        name: æ ‹ä»”ä¸»é¢˜å›ºä»¶ ${{ github.event.inputs.version }} - ${{ env.device_arch }}
        body: |
          # ğŸ  æ ‹ä»”ä¸»é¢˜ä¸ªæ€§åŒ–å›ºä»¶
          
          ## ğŸ“‹ ç¼–è¯‘ä¿¡æ¯
          - **ç¼–è¯‘æ—¶é—´**: $(date)
          - **ç‰ˆæœ¬ç±»å‹**: ${{ github.event.inputs.version }}
          - **ç›®æ ‡å¹³å°**: ${{ env.device_arch }}
          - **æºç åŸºç¡€**: coolsnowwolf/lede
          - **ä¸ªæ€§åŒ–**: æ ‹ä»”ä¸»é¢˜å®šåˆ¶
          
          ## ğŸ¨ ç‰¹è‰²åŠŸèƒ½
          - âœ¨ æ·±åº¦å®šåˆ¶çš„æ ‹ä»”ä¸ªæ€§åŒ–ä¸»é¢˜
          - ğŸ¯ ä¼˜åŒ–çš„ç”¨æˆ·ç•Œé¢ä½“éªŒ
          - ğŸ“± è‰¯å¥½çš„ç§»åŠ¨ç«¯é€‚é…
          - ğŸ”§ åŸºäºLeanç¨³å®šæºç 
          
          ## âš™ï¸ é…ç½®é©±åŠ¨
          æ­¤å›ºä»¶å®Œå…¨ç”± `.config` æ–‡ä»¶é©±åŠ¨ç¼–è¯‘ï¼Œæ”¯æŒçµæ´»åˆ‡æ¢å„ç§è®¾å¤‡å¹³å°ã€‚
          
          ## ğŸ“¦ åŒ…å«å†…å®¹
          - æ ‹ä»”ä¸ªæ€§åŒ–ä¸»é¢˜ç•Œé¢
          - æ ¹æ®é…ç½®æ–‡ä»¶å®šåˆ¶çš„è½¯ä»¶åŒ…
          - ç³»ç»ŸåŸºç¡€åŠŸèƒ½
        files: lede/bin/targets/**/*.bin
        draft: false
        prerelease: ${{ github.event.inputs.version == 'dev' }}

    - name: ç¼–è¯‘æ€»ç»“
      if: always()
      run: |
        echo "=========================================="
        echo "           ğŸ ç¼–è¯‘ä»»åŠ¡å®Œæˆ"
        echo "=========================================="
        if [ "${{ success() }}" = "true" ]; then
          if [ "${{ steps.collect_results.outputs.has_firmware }}" = "true" ]; then
            echo "âœ… ç¼–è¯‘æˆåŠŸ!"
            echo "ğŸ“Š ç”Ÿæˆ ${{ steps.collect_results.outputs.firmware_count }} ä¸ªå›ºä»¶æ–‡ä»¶"
            echo "ğŸ·ï¸ å¹³å°: ${{ env.device_arch }}"
          else
            echo "âš ï¸ ç¼–è¯‘å®Œæˆä½†æœªæ‰¾åˆ°å›ºä»¶æ–‡ä»¶"
          fi
        else
          echo "âŒ ç¼–è¯‘å¤±è´¥!"
        fi
