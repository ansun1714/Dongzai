name: OpenWrtæ•´åˆç‰ˆç¼–è¯‘ï¼ˆç¨³å¥è™šæ‹Ÿç£ç›˜æ–¹æ¡ˆï¼‰

on:
  workflow_dispatch:
    inputs:
      compile_threads:
        description: 'ç¼–è¯‘çº¿ç¨‹æ•°ï¼ˆå»ºè®®é¦–æ¬¡ä½¿ç”¨1ï¼‰'
        required: false
        default: '1'
        type: choice
        options:
          - '1'
          - '2'
      use_ccache:
        description: 'ä½¿ç”¨ç¼–è¯‘ç¼“å­˜åŠ é€Ÿï¼ˆå ç”¨æ›´å¤šç©ºé—´ä½†åŠ é€Ÿåç»­ç¼–è¯‘ï¼‰'
        required: false
        default: 'false'
        type: choice
        options:
          - 'true'
          - 'false'
      clean_build:
        description: 'å®Œå…¨æ¸…ç†é‡æ–°ç¼–è¯‘'
        required: false
        default: 'false'
        type: choice
        options:
          - 'true'
          - 'false'

env:
  REPO_URL: https://github.com/coolsnowwolf/lede
  BUILD_ROOT: /builder
  BUILD_DIR: /builder/openwrt-build
  CCACHE_DIR: /builder/ccache
  DOWNLOAD_DIR: /builder/dl
  TZ: Asia/Shanghai

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 420  # 7å°æ—¶è¶…æ—¶

    steps:
    # ========== é˜¶æ®µ1ï¼šå‡†å¤‡å’ŒéªŒè¯ ==========
    - name: æ£€æŸ¥å·¥ä½œæµè¿è¡Œç¯å¢ƒ
      id: env_check
      run: |
        echo "=== ç¯å¢ƒæ£€æŸ¥å¼€å§‹ ==="
        echo "Runner OS: $(uname -a)"
        echo "CPUæ¶æ„: $(uname -m)"
        echo "å†…å­˜: $(free -h | awk '/^Mem:/{print $2}')"
        echo "ç£ç›˜ç©ºé—´:"
        df -h
        echo "GitHub Workspace: ${{ github.workspace }}"
        
        # æ£€æŸ¥å¿…éœ€æ–‡ä»¶
        echo "æ£€æŸ¥é…ç½®æ–‡ä»¶..."
        if [ ! -f ".config" ]; then
          echo "âŒ é”™è¯¯ï¼šæœªæ‰¾åˆ° .config æ–‡ä»¶"
          echo "è¯·åœ¨ä»“åº“æ ¹ç›®å½•ä¸Šä¼ æ‚¨çš„ .config æ–‡ä»¶"
          exit 1
        fi
        
        CONFIG_SIZE=$(wc -l < .config)
        CONFIG_PACKAGES=$(grep -c '^CONFIG_PACKAGE_' .config 2>/dev/null || echo "0")
        echo "âœ… æ‰¾åˆ° .config æ–‡ä»¶ï¼ˆ${CONFIG_SIZE}è¡Œï¼Œ${CONFIG_PACKAGES}ä¸ªè½¯ä»¶åŒ…ï¼‰"
        
        if [ $CONFIG_PACKAGES -gt 250 ]; then
          echo "âš ï¸ è­¦å‘Šï¼šé…ç½®æ–‡ä»¶åŒ…å« ${CONFIG_PACKAGES} ä¸ªè½¯ä»¶åŒ…ï¼Œå¯èƒ½å ç”¨å¤§é‡ç©ºé—´"
        fi
        
        if [ -f "feed.conf.default" ]; then
          echo "âœ… æ‰¾åˆ° feed.conf.default æ–‡ä»¶"
          echo "feedæºé¢„è§ˆ:"
          head -5 feed.conf.default
        fi
        
        echo "ç¯å¢ƒæ£€æŸ¥å®Œæˆ"
        echo "config_packages=${CONFIG_PACKAGES}" >> $GITHUB_OUTPUT

    - name: åˆå§‹åŒ–ç³»ç»Ÿç¯å¢ƒ
      id: init_system
      continue-on-error: false
      run: |
        echo "=== ç³»ç»Ÿç¯å¢ƒåˆå§‹åŒ– ==="
        
        # è®¾ç½®æ—¶åŒº
        sudo timedatectl set-timezone ${{ env.TZ }}
        
        # æ›´æ–°ç³»ç»ŸåŒ…åˆ—è¡¨
        echo "æ›´æ–°åŒ…åˆ—è¡¨..."
        sudo apt-get update -q
        
        # å®‰è£…åŸºç¡€å·¥å…·
        echo "å®‰è£…åŸºç¡€å·¥å…·..."
        sudo DEBIAN_FRONTEND=noninteractive apt-get install -y \
          curl wget git ca-certificates lsb-release \
          software-properties-common apt-transport-https \
          gnupg2 jq tree pv htop iotop iftop
        
        # æ¸…ç†ä¸éœ€è¦çš„åŒ…é‡Šæ”¾ç©ºé—´
        echo "æ¸…ç†ç³»ç»Ÿç©ºé—´..."
        sudo apt-get autoremove -y --purge
        sudo apt-get clean
        sudo rm -rf /var/lib/apt/lists/*
        
        # åˆ›å»ºå¿…è¦ç›®å½•ç»“æ„
        sudo mkdir -p /mnt/work /builder
        sudo chown -R runner:runner /mnt/work /builder
        
        echo "âœ… ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆ"
        echo "å½“å‰ç£ç›˜ç©ºé—´:"
        df -h

    # ========== é˜¶æ®µ2ï¼šåˆ›å»ºè™šæ‹Ÿå·¥ä½œç£ç›˜ ==========
    - name: åˆ›å»ºè™šæ‹Ÿå·¥ä½œç£ç›˜
      id: create_vdisk
      continue-on-error: false
      run: |
        echo "=== åˆ›å»ºè™šæ‹Ÿå·¥ä½œç£ç›˜ ==="
        
        # æ£€æŸ¥ç°æœ‰è™šæ‹Ÿç£ç›˜
        if mount | grep -q "${{ env.BUILD_ROOT }}"; then
          echo "âš ï¸ è™šæ‹Ÿç£ç›˜å·²æŒ‚è½½ï¼Œå°è¯•æ¸…ç†..."
          sudo umount ${{ env.BUILD_ROOT }} 2>/dev/null || true
        fi
        
        # æ¸…ç†æ—§çš„è™šæ‹Ÿç£ç›˜
        sudo dmsetup remove /dev/mapper/builder_vg-workspace 2>/dev/null || true
        sudo vgremove -f builder_vg 2>/dev/null || true
        sudo pvremove -f /dev/loop10 2>/dev/null || true
        sudo losetup -d /dev/loop10 2>/dev/null || true
        sudo rm -f /mnt/work/disk.img 2>/dev/null || true
        
        # è®¡ç®—å¯ç”¨ç©ºé—´ï¼ˆä¿å®ˆä¼°è®¡ï¼‰
        echo "è®¡ç®—å¯ç”¨ç©ºé—´..."
        if mount | grep -q ' /mnt '; then
          AVAIL_GB=$(df -BG /mnt | tail -1 | awk '{print $4}' | sed 's/G//')
          WORKDIR="/mnt/work"
        else
          AVAIL_GB=$(df -BG / | tail -1 | awk '{print $4}' | sed 's/G//')
          WORKDIR="/tmp/work"
          sudo mkdir -p $WORKDIR
        fi
        
        # é¢„ç•™ç³»ç»Ÿç©ºé—´ï¼ˆè‡³å°‘4GBï¼‰
        if [ $AVAIL_GB -lt 15 ]; then
          echo "âŒ é”™è¯¯ï¼šå¯ç”¨ç©ºé—´ä¸è¶³ï¼Œéœ€è¦è‡³å°‘15GBï¼Œå½“å‰ä»… ${AVAIL_GB}GB"
          df -h
          exit 1
        fi
        
        DISK_SIZE=$((AVAIL_GB - 4))
        echo "å¯ç”¨ç©ºé—´: ${AVAIL_GB}GBï¼Œå°†åˆ›å»º ${DISK_SIZE}GB è™šæ‹Ÿç£ç›˜"
        
        # åˆ›å»ºè™šæ‹Ÿç£ç›˜æ–‡ä»¶
        echo "åˆ›å»ºè™šæ‹Ÿç£ç›˜æ–‡ä»¶ï¼ˆ${DISK_SIZE}GBï¼‰..."
        sudo dd if=/dev/zero of=${WORKDIR}/disk.img bs=1G count=${DISK_SIZE} status=progress
        echo "è™šæ‹Ÿç£ç›˜æ–‡ä»¶åˆ›å»ºå®Œæˆ"
        
        # è®¾ç½®å›ç¯è®¾å¤‡
        echo "è®¾ç½®å›ç¯è®¾å¤‡..."
        sudo losetup /dev/loop10 ${WORKDIR}/disk.img
        
        # åˆ›å»ºLVMé€»è¾‘å·
        echo "åˆ›å»ºLVMå·..."
        sudo pvcreate /dev/loop10
        sudo vgcreate builder_vg /dev/loop10
        sudo lvcreate -l 100%FREE -n workspace builder_vg
        
        # æ ¼å¼åŒ–ä¸ºext4ï¼ˆæ›´ç¨³å®šå…¼å®¹ï¼‰
        echo "æ ¼å¼åŒ–ç£ç›˜..."
        sudo mkfs.ext4 -F /dev/builder_vg/workspace
        
        # æŒ‚è½½è™šæ‹Ÿç£ç›˜
        echo "æŒ‚è½½è™šæ‹Ÿç£ç›˜..."
        sudo mount /dev/builder_vg/workspace ${{ env.BUILD_ROOT }}
        sudo chown -R runner:runner ${{ env.BUILD_ROOT }}
        sudo chmod 755 ${{ env.BUILD_ROOT }}
        
        # åˆ›å»ºç›®å½•ç»“æ„
        mkdir -p ${{ env.BUILD_DIR }} ${{ env.CCACHE_DIR }} ${{ env.DOWNLOAD_DIR }}
        
        echo "âœ… è™šæ‹Ÿç£ç›˜åˆ›å»ºå®Œæˆ"
        echo "ç£ç›˜ä¿¡æ¯:"
        df -h ${{ env.BUILD_ROOT }}
        echo "è™šæ‹Ÿç£ç›˜è·¯å¾„: ${WORKDIR}/disk.img"
        echo "å¯ç”¨ç¼–è¯‘ç©ºé—´: $(df -h ${{ env.BUILD_ROOT }} | tail -1 | awk '{print $4}')"
        
        echo "vdisk_status=success" >> $GITHUB_OUTPUT
        echo "vdisk_size=${DISK_SIZE}" >> $GITHUB_OUTPUT

    # ========== é˜¶æ®µ3ï¼šå®‰è£…ç¼–è¯‘ç¯å¢ƒ ==========
    - name: å®‰è£…ç¼–è¯‘å·¥å…·é“¾
      id: install_tools
      continue-on-error: false
      run: |
        echo "=== å®‰è£…OpenWrtç¼–è¯‘å·¥å…·é“¾ ==="
        
        # æ›´æ–°åŒ…åˆ—è¡¨
        sudo apt-get update
        
        # å®‰è£…ç¼–è¯‘å¿…éœ€å·¥å…·ï¼ˆåˆ†ç»„å®‰è£…ä¾¿äºè°ƒè¯•ï¼‰
        echo "å®‰è£…åŸºç¡€ç¼–è¯‘å·¥å…·..."
        sudo DEBIAN_FRONTEND=noninteractive apt-get install -y \
          build-essential \
          git \
          libncurses5-dev \
          libssl-dev \
          python3 \
          python3-pip \
          python3-venv \
          unzip \
          wget \
          curl
        
        echo "å®‰è£…äº¤å‰ç¼–è¯‘å·¥å…·..."
        sudo DEBIAN_FRONTEND=noninteractive apt-get install -y \
          gcc \
          g++ \
          binutils \
          gcc-aarch64-linux-gnu \
          g++-aarch64-linux-gnu \
          binutils-aarch64-linux-gnu
        
        echo "å®‰è£…ç¼–è¯‘è¾…åŠ©å·¥å…·..."
        sudo DEBIAN_FRONTEND=noninteractive apt-get install -y \
          patch \
          bzip2 \
          flex \
          bison \
          make \
          rsync \
          cmake \
          gawk \
          sed \
          gettext \
          pkg-config \
          libtool \
          autoconf \
          automake \
          texinfo
        
        echo "å®‰è£…æ–‡ä»¶ç³»ç»Ÿå·¥å…·..."
        sudo DEBIAN_FRONTEND=noninteractive apt-get install -y \
          zlib1g-dev \
          liblzma-dev \
          liblzo2-dev \
          libbz2-dev \
          libzstd-dev \
          libfuse-dev
        
        echo "å®‰è£…å…¶ä»–ä¾èµ–..."
        sudo DEBIAN_FRONTEND=noninteractive apt-get install -y \
          subversion \
          mercurial \
          ccache \
          ecj \
          fastjar \
          file \
          gperf \
          libglib2.0-dev \
          libxml2-utils
        
        # é…ç½®ccacheï¼ˆå¦‚æœå¯ç”¨ï¼‰
        if [ "${{ inputs.use_ccache }}" = "true" ]; then
          echo "é…ç½®ccache..."
          sudo ccache -M 2G
          echo "CCACHE_DIR=${{ env.CCACHE_DIR }}" | sudo tee -a /etc/environment
          export CCACHE_DIR="${{ env.CCACHE_DIR }}"
          ccache -s
        fi
        
        echo "âœ… ç¼–è¯‘å·¥å…·é“¾å®‰è£…å®Œæˆ"
        echo "å·¥å…·ç‰ˆæœ¬ä¿¡æ¯:"
        gcc --version | head -1
        make --version | head -1
        python3 --version

    # ========== é˜¶æ®µ4ï¼šè·å–æºç å’Œé…ç½® ==========
    - name: è·å–OpenWrtæºç 
      id: get_source
      run: |
        cd ${{ env.BUILD_ROOT }}
        
        echo "=== è·å–OpenWrtæºç  ==="
        echo "å½“å‰ç›®å½•: $(pwd)"
        echo "å¯ç”¨ç©ºé—´:"
        df -h .
        
        # æ¸…ç†æ—§ç›®å½•ï¼ˆå¦‚æœé€‰æ‹©å®Œå…¨æ¸…ç†ï¼‰
        if [ "${{ inputs.clean_build }}" = "true" ]; then
          echo "å®Œå…¨æ¸…ç†æ¨¡å¼ï¼Œåˆ é™¤æ—§ç›®å½•..."
          rm -rf openwrt-build
        fi
        
        if [ ! -d "openwrt-build" ]; then
          echo "å…‹éš†OpenWrtæºç ..."
          git clone --depth=1 --single-branch --branch master "${{ env.REPO_URL }}" openwrt-build
          
          if [ $? -ne 0 ]; then
            echo "âŒ æºç å…‹éš†å¤±è´¥"
            exit 1
          fi
          
          echo "âœ… æºç å…‹éš†å®Œæˆ"
        else
          echo "ä½¿ç”¨å·²å­˜åœ¨çš„æºç ç›®å½•"
          cd openwrt-build
          echo "æ›´æ–°æºç ..."
          git pull origin master || echo "âš ï¸ æ›´æ–°å¤±è´¥ï¼Œä½¿ç”¨ç°æœ‰ä»£ç "
          cd ..
        fi
        
        echo "æºç ç›®å½•å¤§å°: $(du -sh openwrt-build | cut -f1)"

    - name: åº”ç”¨è‡ªå®šä¹‰é…ç½®
      id: apply_config
      run: |
        cd ${{ env.BUILD_DIR }}
        
        echo "=== åº”ç”¨è‡ªå®šä¹‰é…ç½® ==="
        
        # å¤‡ä»½åŸå§‹é…ç½®
        if [ -f "feeds.conf.default" ]; then
          cp feeds.conf.default feeds.conf.default.orig
        fi
        
        # åº”ç”¨ç”¨æˆ·é…ç½®
        echo "åº”ç”¨.configæ–‡ä»¶..."
        cp "${{ github.workspace }}/.config" .
        
        if [ -f "${{ github.workspace }}/feed.conf.default" ]; then
          echo "åº”ç”¨feed.conf.defaultæ–‡ä»¶..."
          cp "${{ github.workspace }}/feed.conf.default" .
        fi
        
        # éªŒè¯é…ç½®
        echo "é…ç½®éªŒè¯:"
        echo "- .config: $(wc -l < .config) è¡Œ"
        if [ -f "feed.conf.default" ]; then
          echo "- feed.conf.default: $(wc -l < feed.conf.default) è¡Œ"
          echo "feedæºåˆ—è¡¨:"
          grep -E '^src-' feed.conf.default || echo "  ä½¿ç”¨é»˜è®¤feedé…ç½®"
        fi
        
        echo "âœ… é…ç½®åº”ç”¨å®Œæˆ"

    - name: åˆå§‹åŒ–OpenWrtç¯å¢ƒ
      id: init_openwrt
      run: |
        cd ${{ env.BUILD_DIR }}
        
        echo "=== åˆå§‹åŒ–OpenWrtç¯å¢ƒ ==="
        echo "å½“å‰ç£ç›˜ç©ºé—´:"
        df -h ${{ env.BUILD_ROOT }}
        
        # æ›´æ–°feeds
        echo "æ›´æ–°feeds..."
        timeout 300 ./scripts/feeds update -a
        if [ $? -ne 0 ]; then
          echo "âš ï¸ feedsæ›´æ–°è¶…æ—¶æˆ–å¤±è´¥ï¼Œå°è¯•ç»§ç»­..."
        fi
        
        # å®‰è£…è½¯ä»¶åŒ…
        echo "å®‰è£…è½¯ä»¶åŒ…..."
        ./scripts/feeds install -a
        
        # åº”ç”¨é»˜è®¤é…ç½®
        echo "ç”Ÿæˆé»˜è®¤é…ç½®..."
        make defconfig
        
        # æ˜¾ç¤ºé…ç½®å·®å¼‚
        echo "é…ç½®å·®å¼‚ï¼ˆå¦‚æœ‰ï¼‰:"
        make defconfig 2>&1 | grep -E "^CONFIG_" || echo "æ— é‡è¦å·®å¼‚"
        
        echo "âœ… ç¯å¢ƒåˆå§‹åŒ–å®Œæˆ"

    # ========== é˜¶æ®µ5ï¼šä¸‹è½½ä¾èµ– ==========
    - name: ä¸‹è½½ä¾èµ–æ–‡ä»¶
      id: download_deps
      timeout-minutes: 30
      run: |
        cd ${{ env.BUILD_DIR }}
        
        echo "=== ä¸‹è½½ä¾èµ–æ–‡ä»¶ ==="
        echo "å½“å‰ç©ºé—´:"
        df -h ${{ env.BUILD_ROOT }}
        
        # ä½¿ç”¨é•œåƒåŠ é€Ÿä¸‹è½½
        echo "è®¾ç½®ä¸‹è½½é•œåƒ..."
        if [ ! -f "feeds.conf.default" ] || ! grep -q "openwrt.pro" "feeds.conf.default"; then
          echo "ä½¿ç”¨æ¸…åé•œåƒæºåŠ é€Ÿ..."
          sed -i 's|git.openwrt.org|github.com/openwrt|g' feeds.conf.default 2>/dev/null || true
        fi
        
        # åˆ›å»ºä¸‹è½½ç›®å½•é“¾æ¥
        rm -rf dl
        ln -s ${{ env.DOWNLOAD_DIR }} dl
        
        # æ£€æŸ¥å·²æœ‰ä¸‹è½½
        DL_COUNT=$(find ${{ env.DOWNLOAD_DIR }} -name "*.tar.*" -o -name "*.zip" -o -name "*.gz" 2>/dev/null | wc -l)
        if [ $DL_COUNT -gt 10 ]; then
          echo "å‘ç° $DL_COUNT ä¸ªå·²ä¸‹è½½æ–‡ä»¶ï¼Œè·³è¿‡éƒ¨åˆ†ä¸‹è½½"
          echo "ä»…ä¸‹è½½ç¼ºå¤±çš„ä¾èµ–..."
          make download -j1 || make download -j1 V=s
        else
          echo "å¼€å§‹ä¸‹è½½æ‰€æœ‰ä¾èµ–..."
          # åˆ†æ‰¹ä¸‹è½½é¿å…è¶…æ—¶
          echo "1. ä¸‹è½½å·¥å…·é“¾..."
          make tools/download -j1 V=s || echo "âš ï¸ å·¥å…·é“¾ä¸‹è½½å¯èƒ½ä¸å®Œæ•´"
          
          echo "2. ä¸‹è½½æ ¸å¿ƒåŒ…..."
          make toolchain/download -j1 V=s || echo "âš ï¸ å·¥å…·é“¾ä¸‹è½½å¯èƒ½ä¸å®Œæ•´"
          
          echo "3. ä¸‹è½½ç›®æ ‡ç›¸å…³..."
          make target/download -j1 V=s || echo "âš ï¸ ç›®æ ‡æ–‡ä»¶ä¸‹è½½å¯èƒ½ä¸å®Œæ•´"
        fi
        
        # å‹ç¼©å·²ä¸‹è½½æ–‡ä»¶èŠ‚çœç©ºé—´
        echo "å‹ç¼©ä¸‹è½½æ–‡ä»¶..."
        find ${{ env.DOWNLOAD_DIR }} -name "*.tar" -type f -exec gzip -f {} \; 2>/dev/null || true
        
        echo "âœ… ä¸‹è½½å®Œæˆ"
        echo "ä¸‹è½½ç¼“å­˜å¤§å°: $(du -sh ${{ env.DOWNLOAD_DIR }} 2>/dev/null || echo "0")"
        echo "å‰©ä½™ç©ºé—´:"
        df -h ${{ env.BUILD_ROOT }}

    # ========== é˜¶æ®µ6ï¼šç¼–è¯‘è¿‡ç¨‹ ==========
    - name: ç¼–è¯‘å·¥å…·é“¾
      id: compile_tools
      timeout-minutes: 60
      run: |
        cd ${{ env.BUILD_DIR }}
        
        echo "=== ç¼–è¯‘å·¥å…·é“¾ ==="
        echo "çº¿ç¨‹æ•°: ${{ inputs.compile_threads }}"
        echo "ç¼–è¯‘å‰ç©ºé—´:"
        df -h ${{ env.BUILD_ROOT }}
        
        # è®¾ç½®ç¼–è¯‘ç¯å¢ƒ
        export FORCE_UNSAFE_CONFIGURE=1
        
        # ç¼–è¯‘å·¥å…·é“¾
        echo "å¼€å§‹ç¼–è¯‘å·¥å…·é“¾..."
        if make tools/compile -j${{ inputs.compile_threads }} V=s 2>&1 | tee /tmp/compile_tools.log; then
          echo "âœ… å·¥å…·é“¾ç¼–è¯‘æˆåŠŸ"
          echo "ç¼–è¯‘åç©ºé—´:"
          df -h ${{ env.BUILD_ROOT }}
        else
          echo "âŒ å·¥å…·é“¾ç¼–è¯‘å¤±è´¥ï¼Œå°è¯•å•çº¿ç¨‹..."
          if make tools/compile -j1 V=s 2>&1 | tee /tmp/compile_tools_single.log; then
            echo "âœ… å·¥å…·é“¾å•çº¿ç¨‹ç¼–è¯‘æˆåŠŸ"
          else
            echo "âŒ å·¥å…·é“¾ç¼–è¯‘æœ€ç»ˆå¤±è´¥"
            echo "æœ€å100è¡Œæ—¥å¿—:"
            tail -100 /tmp/compile_tools_single.log
            exit 1
          fi
        fi
        
        # æ¸…ç†ä¸­é—´æ–‡ä»¶
        find . -name "*.o" -type f -delete 2>/dev/null || true

    - name: ç¼–è¯‘ç›®æ ‡å·¥å…·é“¾
      id: compile_toolchain
      timeout-minutes: 90
      run: |
        cd ${{ env.BUILD_DIR }}
        
        echo "=== ç¼–è¯‘ç›®æ ‡å·¥å…·é“¾ ==="
        echo "ç¼–è¯‘å‰ç©ºé—´:"
        df -h ${{ env.BUILD_ROOT }}
        
        # æ£€æŸ¥ç©ºé—´
        AVAIL_MB=$(df -m ${{ env.BUILD_ROOT }} | tail -1 | awk '{print $4}')
        if [ $AVAIL_MB -lt 1024 ]; then
          echo "âš ï¸ ç©ºé—´ç´§å¼ ï¼ˆä»… ${AVAIL_MB}MBï¼‰ï¼Œæ¸…ç†ä¸­é—´æ–‡ä»¶..."
          find . -name "*.o" -type f -delete 2>/dev/null || true
          find . -name "*.a" -type f -delete 2>/dev/null || true
        fi
        
        echo "å¼€å§‹ç¼–è¯‘ç›®æ ‡å·¥å…·é“¾..."
        if make toolchain/compile -j${{ inputs.compile_threads }} V=s 2>&1 | tee /tmp/compile_toolchain.log; then
          echo "âœ… ç›®æ ‡å·¥å…·é“¾ç¼–è¯‘æˆåŠŸ"
        else
          echo "âŒ ç›®æ ‡å·¥å…·é“¾ç¼–è¯‘å¤±è´¥ï¼Œå°è¯•å•çº¿ç¨‹..."
          if make toolchain/compile -j1 V=s 2>&1 | tee /tmp/compile_toolchain_single.log; then
            echo "âœ… ç›®æ ‡å·¥å…·é“¾å•çº¿ç¨‹ç¼–è¯‘æˆåŠŸ"
          else
            echo "âŒ ç›®æ ‡å·¥å…·é“¾ç¼–è¯‘æœ€ç»ˆå¤±è´¥"
            echo "å»ºè®®: 1) å‡å°‘.configä¸­çš„è½¯ä»¶åŒ… 2) å¢åŠ ç¼–è¯‘ç©ºé—´"
            exit 1
          fi
        fi
        
        echo "ç¼–è¯‘åç©ºé—´:"
        df -h ${{ env.BUILD_ROOT }}

    - name: ç¼–è¯‘ç›®æ ‡æ–‡ä»¶
      id: compile_target
      timeout-minutes: 90
      run: |
        cd ${{ env.BUILD_DIR }}
        
        echo "=== ç¼–è¯‘ç›®æ ‡æ–‡ä»¶ ==="
        
        # ç©ºé—´æ£€æŸ¥
        echo "ç©ºé—´æ£€æŸ¥:"
        df -h ${{ env.BUILD_ROOT }}
        
        echo "å¼€å§‹ç¼–è¯‘ç›®æ ‡æ–‡ä»¶..."
        if make target/compile -j${{ inputs.compile_threads }} V=s 2>&1 | tee /tmp/compile_target.log; then
          echo "âœ… ç›®æ ‡æ–‡ä»¶ç¼–è¯‘æˆåŠŸ"
          
          # æ¸…ç†é‡Šæ”¾ç©ºé—´
          echo "æ¸…ç†ä¸­é—´æ–‡ä»¶..."
          find build_dir -name "*.o" -type f -delete 2>/dev/null || true
          find build_dir -name "*.a" -type f -delete 2>/dev/null || true
        else
          echo "âŒ ç›®æ ‡æ–‡ä»¶ç¼–è¯‘å¤±è´¥ï¼Œå°è¯•å•çº¿ç¨‹..."
          if make target/compile -j1 V=s 2>&1 | tee /tmp/compile_target_single.log; then
            echo "âœ… ç›®æ ‡æ–‡ä»¶å•çº¿ç¨‹ç¼–è¯‘æˆåŠŸ"
          else
            echo "âŒ ç›®æ ‡æ–‡ä»¶ç¼–è¯‘æœ€ç»ˆå¤±è´¥"
            exit 1
          fi
        fi

    - name: ç¼–è¯‘è½¯ä»¶åŒ…
      id: compile_packages
      timeout-minutes: 120
      run: |
        cd ${{ env.BUILD_DIR }}
        
        echo "=== ç¼–è¯‘è½¯ä»¶åŒ… ==="
        echo "æœ€ç»ˆç©ºé—´æ£€æŸ¥:"
        df -h ${{ env.BUILD_ROOT }}
        
        AVAIL_GB=$(df -BG ${{ env.BUILD_ROOT }} | tail -1 | awk '{print $4}' | sed 's/G//')
        if [ $AVAIL_GB -lt 2 ]; then
          echo "âš ï¸ ä¸¥é‡è­¦å‘Šï¼šä»…å‰© ${AVAIL_GB}GB ç©ºé—´"
          echo "æ‰§è¡Œç´§æ€¥æ¸…ç†..."
          
          # æ¸…ç†ç­–ç•¥
          echo "1. æ¸…ç†æ‰€æœ‰.oæ–‡ä»¶..."
          find . -name "*.o" -type f -delete 2>/dev/null || true
          
          echo "2. æ¸…ç†ä¸´æ—¶æ–‡ä»¶..."
          rm -rf tmp 2>/dev/null || true
          
          echo "3. æ¸…ç†ä¸‹è½½ç¼“å­˜ï¼ˆä¿ç•™æœ€æ–°çš„10ä¸ªï¼‰..."
          find ${{ env.DOWNLOAD_DIR }} -type f -name "*.tar.*" -o -name "*.zip" -o -name "*.gz" 2>/dev/null | \
            xargs ls -t 2>/dev/null | tail -n +11 | xargs rm -f 2>/dev/null || true
          
          echo "æ¸…ç†åç©ºé—´:"
          df -h ${{ env.BUILD_ROOT }}
        fi
        
        echo "å¼€å§‹ç¼–è¯‘è½¯ä»¶åŒ…..."
        if make package/compile -j${{ inputs.compile_threads }} V=s 2>&1 | tee /tmp/compile_packages.log; then
          echo "âœ… è½¯ä»¶åŒ…ç¼–è¯‘æˆåŠŸ"
        else
          echo "âŒ è½¯ä»¶åŒ…ç¼–è¯‘å¤±è´¥ï¼Œå°è¯•å•çº¿ç¨‹..."
          if make package/compile -j1 V=s 2>&1 | tee /tmp/compile_packages_single.log; then
            echo "âœ… è½¯ä»¶åŒ…å•çº¿ç¨‹ç¼–è¯‘æˆåŠŸ"
          else
            echo "âŒ è½¯ä»¶åŒ…ç¼–è¯‘æœ€ç»ˆå¤±è´¥"
            echo "å¯èƒ½æ˜¯æŸäº›è½¯ä»¶åŒ…ä¾èµ–é—®é¢˜ï¼Œæ£€æŸ¥.configé…ç½®"
            exit 1
          fi
        fi

    - name: æœ€ç»ˆç¼–è¯‘å’Œæ‰“åŒ…
      id: final_compile
      timeout-minutes: 60
      run: |
        cd ${{ env.BUILD_DIR }}
        
        echo "=== æœ€ç»ˆç¼–è¯‘å’Œæ‰“åŒ… ==="
        echo "æœ€ç»ˆç©ºé—´çŠ¶æ€:"
        df -h ${{ env.BUILD_ROOT }}
        
        echo "æ‰§è¡Œæœ€ç»ˆç¼–è¯‘..."
        if make -j${{ inputs.compile_threads }} 2>&1 | tee /tmp/final_compile.log; then
          echo "ğŸ‰ OpenWrtç¼–è¯‘æˆåŠŸå®Œæˆï¼"
          
          # æ˜¾ç¤ºç”Ÿæˆçš„æ–‡ä»¶
          echo "ç”Ÿæˆçš„æ–‡ä»¶:"
          find bin -name "*.bin" -o -name "*.img" -o -name "*.gz" -o -name "*.trx" 2>/dev/null | while read file; do
            echo "  ğŸ“„ $(basename "$file") - $(ls -lh "$file" | awk '{print $5}')"
          done || echo "  æœªæ‰¾åˆ°å›ºä»¶æ–‡ä»¶"
        else
          echo "âŒ æœ€ç»ˆç¼–è¯‘å¤±è´¥ï¼Œå°è¯•å•çº¿ç¨‹æœ€ç»ˆç¼–è¯‘..."
          if make -j1 V=s 2>&1 | tee /tmp/final_compile_single.log; then
            echo "ğŸ‰ å•çº¿ç¨‹æœ€ç»ˆç¼–è¯‘æˆåŠŸï¼"
          else
            echo "âŒ æœ€ç»ˆç¼–è¯‘å¤±è´¥"
            echo "ç¼–è¯‘æ—¥å¿—å·²ä¿å­˜ï¼Œè¯·æ£€æŸ¥é”™è¯¯"
            exit 1
          fi
        fi

    # ========== é˜¶æ®µ7ï¼šç»“æœå¤„ç†å’Œæ¸…ç† ==========
    - name: éªŒè¯å’Œæ”¶é›†å›ºä»¶
      id: collect_firmware
      if: success()
      run: |
        cd ${{ env.BUILD_DIR }}
        
        echo "=== éªŒè¯ç”Ÿæˆçš„å›ºä»¶ ==="
        
        # æŸ¥æ‰¾æ‰€æœ‰å›ºä»¶æ–‡ä»¶
        FIRMWARE_FILES=$(find bin -type f \( -name "*.bin" -o -name "*.img" -o -name "*.gz" -o -name "*.trx" \) 2>/dev/null)
        
        if [ -z "$FIRMWARE_FILES" ]; then
          echo "âŒ é”™è¯¯ï¼šæœªæ‰¾åˆ°ä»»ä½•å›ºä»¶æ–‡ä»¶"
          echo "binç›®å½•å†…å®¹:"
          ls -la bin/ 2>/dev/null || true
          echo "å¯èƒ½çš„å­ç›®å½•:"
          find bin -type d 2>/dev/null || true
          exit 1
        fi
        
        echo "âœ… æ‰¾åˆ°å›ºä»¶æ–‡ä»¶:"
        TOTAL_SIZE=0
        for file in $FIRMWARE_FILES; do
          if [ -f "$file" ]; then
            SIZE=$(ls -lh "$file" | awk '{print $5}')
            echo "  ğŸ“„ $(basename "$file") - ${SIZE}"
            # è®¡ç®—æ€»å¤§å°ï¼ˆå­—èŠ‚ï¼‰
            FSIZE=$(stat -c%s "$file" 2>/dev/null || echo "0")
            TOTAL_SIZE=$((TOTAL_SIZE + FSIZE))
          fi
        done
        
        # è½¬æ¢æ€»å¤§å°ä¸ºæ˜“è¯»æ ¼å¼
        if [ $TOTAL_SIZE -gt 1073741824 ]; then
          TOTAL_READABLE=$(echo "scale=2; $TOTAL_SIZE/1073741824" | bc)GB
        elif [ $TOTAL_SIZE -gt 1048576 ]; then
          TOTAL_READABLE=$(echo "scale=2; $TOTAL_SIZE/1048576" | bc)MB
        else
          TOTAL_READABLE=$(echo "scale=2; $TOTAL_SIZE/1024" | bc)KB
        fi
        
        echo "å›ºä»¶æ€»æ•°: $(echo "$FIRMWARE_FILES" | wc -w)"
        echo "å›ºä»¶æ€»å¤§å°: ${TOTAL_READABLE}"
        
        # ä¿å­˜å›ºä»¶åˆ—è¡¨ä¾›åç»­æ­¥éª¤ä½¿ç”¨
        echo "$FIRMWARE_FILES" > /tmp/firmware_list.txt
        echo "firmware_count=$(echo "$FIRMWARE_FILES" | wc -w)" >> $GITHUB_OUTPUT

    - name: ä¸Šä¼ å›ºä»¶æ–‡ä»¶
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: openwrt-firmware
        path: ${{ env.BUILD_DIR }}/bin/
        retention-days: 30
        if-no-files-found: error

    - name: æ¸…ç†è™šæ‹Ÿç£ç›˜
      if: always()
      run: |
        echo "=== æ¸…ç†è™šæ‹Ÿç£ç›˜ ==="
        
        # ç¡®ä¿å·¥ä½œç›®å½•ä¸å†ä½¿ç”¨
        cd /tmp
        
        # å¸è½½è™šæ‹Ÿç£ç›˜
        sudo umount ${{ env.BUILD_ROOT }} 2>/dev/null || echo "å¸è½½å¤±è´¥æˆ–å·²å¸è½½"
        
        # ç§»é™¤LVMé€»è¾‘å·
        sudo dmsetup remove /dev/mapper/builder_vg-workspace 2>/dev/null || true
        sudo lvremove -f /dev/builder_vg/workspace 2>/dev/null || true
        sudo vgremove -f builder_vg 2>/dev/null || true
        sudo pvremove -f /dev/loop10 2>/dev/null || true
        sudo losetup -d /dev/loop10 2>/dev/null || true
        
        # åˆ é™¤è™šæ‹Ÿç£ç›˜æ–‡ä»¶
        sudo rm -f /mnt/work/disk.img /tmp/work/disk.img 2>/dev/null || true
        
        echo "âœ… è™šæ‹Ÿç£ç›˜æ¸…ç†å®Œæˆ"

    - name: ç¼–è¯‘ç»“æœæŠ¥å‘Š
      if: always()
      run: |
        echo "===================================
