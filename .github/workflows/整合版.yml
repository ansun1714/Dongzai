name: OpenWrtç¼–è¯‘æ•´åˆç‰ˆï¼ˆä¿®å¤feedæ–‡ä»¶åé—®é¢˜ï¼‰

on:
  workflow_dispatch:
    inputs:
      compile_threads:
        description: 'ç¼–è¯‘çº¿ç¨‹æ•°'
        required: false
        default: '1'
        type: choice
        options:
          - '1'
          - '2'

env:
  REPO_URL: https://github.com/coolsnowwolf/lede
  BUILD_DIR: /builder/openwrt-build

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 360

    steps:
    # ========== é˜¶æ®µ1ï¼šåŸºç¡€å‡†å¤‡ ==========
    - name: æ£€å‡ºä»“åº“ä»£ç 
      uses: actions/checkout@v4

    - name: éªŒè¯é…ç½®æ–‡ä»¶ï¼ˆä¿®å¤ç‰ˆï¼‰
      id: verify_config
      run: |
        echo "=== éªŒè¯é…ç½®æ–‡ä»¶ ==="
        echo "å½“å‰ç›®å½•: $(pwd)"
        echo "å®Œæ•´æ–‡ä»¶åˆ—è¡¨:"
        ls -la
        echo ""
        
        # æ£€æŸ¥é…ç½®æ–‡ä»¶ï¼ˆæ”¯æŒå¤šç§å¯èƒ½åç§°ï¼‰
        if [ -f ".config" ]; then
          echo "âœ… æ‰¾åˆ° .config æ–‡ä»¶"
          echo "config_exists=true" >> $GITHUB_OUTPUT
        else
          echo "âŒ é”™è¯¯ï¼šæœªæ‰¾åˆ° .config æ–‡ä»¶"
          echo "è¯·ç¡®ä¿å·²å°† .config æ–‡ä»¶ä¸Šä¼ åˆ°ä»“åº“æ ¹ç›®å½•"
          exit 1
        fi
        
        # æ£€æŸ¥feedé…ç½®æ–‡ä»¶ï¼ˆæ”¯æŒå¤šç§å¯èƒ½åç§°ï¼‰
        FEED_FILES=""
        for file in "feeds.conf.default" "feed.conf.default" "feeds.conf" "feed.conf"; do
          if [ -f "$file" ]; then
            FEED_FILES="$FEED_FILES $file"
            echo "âœ… æ‰¾åˆ° feed é…ç½®æ–‡ä»¶: $file"
          fi
        done
        
        if [ -n "$FEED_FILES" ]; then
          echo "æ‰¾åˆ°çš„feedæ–‡ä»¶: $FEED_FILES"
          # ä½¿ç”¨ç¬¬ä¸€ä¸ªæ‰¾åˆ°çš„feedæ–‡ä»¶
          FIRST_FEED=$(echo $FEED_FILES | awk '{print $1}')
          echo "å°†ä½¿ç”¨: $FIRST_FEED"
          echo "feed_file=$FIRST_FEED" >> $GITHUB_OUTPUT
          echo "feed_exists=true" >> $GITHUB_OUTPUT
        else
          echo "âš ï¸ æœªæ‰¾åˆ°ä»»ä½• feed é…ç½®æ–‡ä»¶ï¼Œå°†ä½¿ç”¨æºç é»˜è®¤é…ç½®"
          echo "feed_exists=false" >> $GITHUB_OUTPUT
        fi

    - name: åˆ›å»ºç¼–è¯‘å·¥ä½œç©ºé—´
      run: |
        echo "=== åˆ›å»ºç¼–è¯‘å·¥ä½œç©ºé—´ ==="
        
        # æ¸…ç†æ—§ç©ºé—´
        sudo rm -rf /builder
        sudo mkdir -p /builder
        
        # åˆ›å»ºè™šæ‹Ÿç£ç›˜ï¼ˆä½¿ç”¨/mntåˆ†åŒºï¼Œé€šå¸¸æ›´å¤§ï¼‰
        sudo dd if=/dev/zero of=/mnt/openwrt.img bs=1M count=20480
        sudo mkfs.ext4 -F /mnt/openwrt.img
        sudo mount /mnt/openwrt.img /builder
        sudo chown -R runner:runner /builder
        
        echo "âœ… å·¥ä½œç©ºé—´åˆ›å»ºå®Œæˆ"
        df -h /builder

    # ========== é˜¶æ®µ2ï¼šç¯å¢ƒå®‰è£… ==========
    - name: å®‰è£…ç¼–è¯‘ç¯å¢ƒ
      run: |
        echo "=== å®‰è£…ç¼–è¯‘ç¯å¢ƒ ==="
        sudo apt-get update
        sudo apt-get install -y \
          build-essential git libncurses5-dev libssl-dev python3 python3-pip \
          unzip wget curl gcc g++ binutils patch bzip2 flex bison make rsync \
          cmake gawk sed gettext pkg-config libtool zlib1g-dev subversion \
          automake autoconf texinfo ccache file gperf
        echo "âœ… ç¼–è¯‘ç¯å¢ƒå®‰è£…å®Œæˆ"

    # ========== é˜¶æ®µ3ï¼šæºç å’Œé…ç½® ==========
    - name: å…‹éš†OpenWrtæºç 
      run: |
        cd /builder
        echo "=== å…‹éš†OpenWrtæºç  ==="
        rm -rf openwrt-build
        git clone --depth=1 --single-branch --branch master "${{ env.REPO_URL }}" openwrt-build
        echo "âœ… æºç å…‹éš†å®Œæˆ"

    - name: åº”ç”¨é…ç½®æ–‡ä»¶ï¼ˆä¿®å¤feedæ–‡ä»¶åé—®é¢˜ï¼‰
      run: |
        cd "${{ env.BUILD_DIR }}"
        echo "=== åº”ç”¨é…ç½®æ–‡ä»¶ ==="
        echo "å½“å‰ç›®å½•: $(pwd)"
        
        # å¤åˆ¶.configæ–‡ä»¶
        echo "å¤åˆ¶.configæ–‡ä»¶..."
        cp "${{ github.workspace }}/.config" .
        echo "âœ… .config å·²å¤åˆ¶"
        
        # å¤åˆ¶feedé…ç½®æ–‡ä»¶ï¼ˆå¦‚æœæœ‰ï¼‰
        if [ "${{ steps.verify_config.outputs.feed_exists }}" = "true" ]; then
          FEED_FILE="${{ steps.verify_config.outputs.feed_file }}"
          echo "å¤åˆ¶feedé…ç½®æ–‡ä»¶: $FEED_FILE"
          cp "${{ github.workspace }}/$FEED_FILE" .
          
          # ç¡®ä¿æ–‡ä»¶åä¸ºfeeds.conf.defaultï¼ˆOpenWrtæ ‡å‡†åç§°ï¼‰
          if [ "$FEED_FILE" != "feeds.conf.default" ]; then
            echo "é‡å‘½å $FEED_FILE ä¸º feeds.conf.default"
            mv "$FEED_FILE" feeds.conf.default
          fi
          echo "âœ… feedé…ç½®æ–‡ä»¶å·²åº”ç”¨"
        else
          echo "âš ï¸ ä½¿ç”¨æºç é»˜è®¤feedé…ç½®"
        fi

    # ========== é˜¶æ®µ4ï¼šåˆå§‹åŒ–ç¯å¢ƒ ==========
    - name: åˆå§‹åŒ–OpenWrtç¯å¢ƒ
      run: |
        cd "${{ env.BUILD_DIR }}"
        echo "=== åˆå§‹åŒ–OpenWrtç¯å¢ƒ ==="
        
        # æ˜¾ç¤ºå½“å‰ä½¿ç”¨çš„feedé…ç½®
        echo "ä½¿ç”¨çš„feedé…ç½®:"
        head -10 feeds.conf.default 2>/dev/null || echo "ä½¿ç”¨é»˜è®¤feedé…ç½®"
        
        # æ›´æ–°feeds
        echo "æ›´æ–°feeds..."
        ./scripts/feeds update -a
        
        echo "å®‰è£…è½¯ä»¶åŒ…..."
        ./scripts/feeds install -a
        
        echo "åº”ç”¨é…ç½®..."
        make defconfig
        
        echo "âœ… ç¯å¢ƒåˆå§‹åŒ–å®Œæˆ"

    # ========== é˜¶æ®µ5ï¼šä¸‹è½½ä¾èµ– ==========
    - name: ä¸‹è½½ä¾èµ–æ–‡ä»¶
      timeout-minutes: 30
      run: |
        cd "${{ env.BUILD_DIR }}"
        echo "=== ä¸‹è½½ä¾èµ–æ–‡ä»¶ ==="
        
        # åˆ›å»ºä¸‹è½½ç›®å½•
        mkdir -p dl
        
        echo "å¼€å§‹ä¸‹è½½ä¾èµ–..."
        echo "1. ä¸‹è½½å·¥å…·é“¾..."
        make tools/download -j1 || make tools/download -j1 V=s
        
        echo "âœ… ä¾èµ–ä¸‹è½½é˜¶æ®µå®Œæˆ"

    # ========== é˜¶æ®µ6ï¼šç¼–è¯‘è¿‡ç¨‹ ==========
    - name: ç¼–è¯‘å·¥å…·é“¾
      timeout-minutes: 60
      run: |
        cd "${{ env.BUILD_DIR }}"
        echo "=== ç¼–è¯‘å·¥å…·é“¾ ==="
        
        echo "å¼€å§‹ç¼–è¯‘å·¥å…·é“¾..."
        if make tools/compile -j${{ inputs.compile_threads }}; then
          echo "âœ… å·¥å…·é“¾ç¼–è¯‘æˆåŠŸ"
        else
          echo "âŒ å·¥å…·é“¾ç¼–è¯‘å¤±è´¥ï¼Œå°è¯•å•çº¿ç¨‹..."
          if make tools/compile -j1 V=s; then
            echo "âœ… å·¥å…·é“¾å•çº¿ç¨‹ç¼–è¯‘æˆåŠŸ"
          else
            echo "âŒ å·¥å…·é“¾ç¼–è¯‘å¤±è´¥"
            exit 1
          fi
        fi

    - name: ç¼–è¯‘æ ¸å¿ƒç»„ä»¶
      timeout-minutes: 120
      run: |
        cd "${{ env.BUILD_DIR }}"
        echo "=== ç¼–è¯‘æ ¸å¿ƒç»„ä»¶ ==="
        
        echo "1. ç¼–è¯‘ç›®æ ‡å·¥å…·é“¾..."
        make toolchain/compile -j${{ inputs.compile_threads }} || make toolchain/compile -j1 V=s
        
        echo "2. ç¼–è¯‘ç›®æ ‡æ–‡ä»¶..."
        make target/compile -j${{ inputs.compile_threads }} || make target/compile -j1 V=s
        
        echo "3. ç¼–è¯‘è½¯ä»¶åŒ…..."
        make package/compile -j${{ inputs.compile_threads }} || make package/compile -j1 V=s
        
        echo "âœ… æ ¸å¿ƒç»„ä»¶ç¼–è¯‘å®Œæˆ"

    - name: æœ€ç»ˆç¼–è¯‘
      timeout-minutes: 60
      run: |
        cd "${{ env.BUILD_DIR }}"
        echo "=== æœ€ç»ˆç¼–è¯‘ ==="
        
        echo "æ‰§è¡Œæœ€ç»ˆç¼–è¯‘..."
        if make -j${{ inputs.compile_threads }}; then
          echo "ğŸ‰ OpenWrtç¼–è¯‘æˆåŠŸï¼"
        else
          echo "âŒ æœ€ç»ˆç¼–è¯‘å¤±è´¥ï¼Œå°è¯•å•çº¿ç¨‹..."
          if make -j1 V=s; then
            echo "ğŸ‰ å•çº¿ç¨‹ç¼–è¯‘æˆåŠŸï¼"
          else
            echo "âŒ æœ€ç»ˆç¼–è¯‘å¤±è´¥"
            exit 1
          fi
        fi

    # ========== é˜¶æ®µ7ï¼šç»“æœå¤„ç† ==========
    - name: æ”¶é›†å›ºä»¶æ–‡ä»¶
      if: success()
      run: |
        cd "${{ env.BUILD_DIR }}"
        echo "=== æ”¶é›†å›ºä»¶æ–‡ä»¶ ==="
        
        # æŸ¥æ‰¾å›ºä»¶æ–‡ä»¶
        find bin -type f \( -name "*.bin" -o -name "*.img" -o -name "*.gz" \) 2>/dev/null | while read file; do
          echo "ğŸ“„ $(basename "$file"): $(ls -lh "$file" | awk '{print $5}')"
        done || echo "æœªæ‰¾åˆ°å›ºä»¶æ–‡ä»¶"

    - name: ä¸Šä¼ å›ºä»¶
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: openwrt-firmware
        path: ${{ env.BUILD_DIR }}/bin/
        retention-days: 30

    - name: æ¸…ç†å·¥ä½œç©ºé—´
      if: always()
      run: |
        echo "=== æ¸…ç†å·¥ä½œç©ºé—´ ==="
        sudo umount /builder 2>/dev/null || true
        sudo rm -f /mnt/openwrt.img 2>/dev/null || true
        echo "âœ… æ¸…ç†å®Œæˆ"

    - name: ç¼–è¯‘ç»“æœæŠ¥å‘Š
      if: always()
      run: |
        echo "========================================"
        if [ "${{ job.status }}" == "success" ]; then
          echo "ğŸ‰ğŸ‰ğŸ‰ ç¼–è¯‘æˆåŠŸï¼ ğŸ‰ğŸ‰ğŸ‰"
          echo ""
          echo "ğŸ“¥ å›ºä»¶æ–‡ä»¶å¯åœ¨ArtifactsåŒºåŸŸä¸‹è½½"
          echo ""
          echo "ğŸ”§ ç¼–è¯‘ä¿¡æ¯:"
          echo "  - ä½¿ç”¨çº¿ç¨‹: ${{ inputs.compile_threads }}"
          echo "  - é…ç½®æ–‡ä»¶: .config"
          if [ "${{ steps.verify_config.outputs.feed_exists }}" = "true" ]; then
            echo "  - Feedé…ç½®: ${{ steps.verify_config.outputs.feed_file }}"
          else
            echo "  - Feedé…ç½®: ä½¿ç”¨æºç é»˜è®¤"
          fi
        else
          echo "âŒâŒâŒ ç¼–è¯‘å¤±è´¥ âŒâŒâŒ"
          echo ""
          echo "ğŸ’¡ è°ƒè¯•å»ºè®®:"
          echo "  1. æ£€æŸ¥å…·ä½“å¤±è´¥æ­¥éª¤çš„æ—¥å¿—"
          echo "  2. ç¡®ä¿.configæ–‡ä»¶æ­£ç¡®"
          echo "  3. å¦‚æœç½‘ç»œé—®é¢˜ï¼Œé‡æ–°è¿è¡Œå·¥ä½œæµ"
        fi
        echo "========================================"
