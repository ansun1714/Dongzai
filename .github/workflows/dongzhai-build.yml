name: ğŸ  æ ‹ä»”ä¸»é¢˜ç¼–è¯‘ - æ— Nodeç‰ˆ

on:
  workflow_dispatch:

env:
  REPO_URL: https://github.com/coolsnowwolf/lede

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 300

    steps:
    - name: ğŸ“‹ åˆå§‹åŒ–æ£€æŸ¥
      uses: actions/checkout@v4

    - name: ğŸ” éªŒè¯é…ç½®æ–‡ä»¶
      run: |
        if [ ! -f ".config" ]; then
          echo "é”™è¯¯ï¼šç¼ºå°‘é…ç½®æ–‡ä»¶"
          exit 1
        fi
        echo "æ‰¾åˆ°é…ç½®æ–‡ä»¶"

    - name: ğŸ› ï¸ å®‰è£…ç¼–è¯‘ç¯å¢ƒ
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential git libncurses5-dev libssl-dev python3 unzip wget curl
        echo "ç¯å¢ƒå®‰è£…å®Œæˆ"

    - name: ğŸ“¥ å…‹éš†æºç 
      run: |
        git clone $REPO_URL lede
        echo "æºç å…‹éš†å®Œæˆ"

    - name: ğŸ”„ æ›´æ–°è½¯ä»¶æº
      run: |
        cd lede
        ./scripts/feeds update -a
        ./scripts/feeds install -a
        echo "è½¯ä»¶æºæ›´æ–°å®Œæˆ"

    - name: ğŸš« å½»åº•ç§»é™¤Node.jsåŒ…
      run: |
        cd lede
        echo "å½»åº•ç§»é™¤Node.jsç›¸å…³åŒ…..."
        
        # ä»feedsä¸­ç§»é™¤nodeåŒ…
        if [ -d "feeds/packages/lang/node" ]; then
          rm -rf feeds/packages/lang/node
          echo "ç§»é™¤ feeds/packages/lang/node"
        fi
        
        # ä»packageç›®å½•ç§»é™¤nodeåŒ…
        if [ -d "package/feeds/packages/node" ]; then
          rm -rf package/feeds/packages/node
          echo "ç§»é™¤ package/feeds/packages/node"
        fi
        
        # åˆ›å»ºç©ºçš„nodeç›®å½•é¿å…é”™è¯¯
        mkdir -p feeds/packages/lang/node
        echo "åˆ›å»ºç©ºnodeç›®å½•"

    - name: ğŸ¨ éƒ¨ç½²æ ‹ä»”ä¸»é¢˜
      run: |
        cd lede
        mkdir -p package/lean/dongzhai-theme/luci-theme-dongzhai/files/www/luci-static/dongzhai/css
        
        # ç®€å•Makefile
        cat > package/lean/dongzhai-theme/luci-theme-dongzhai/Makefile << 'EOF'
include $(TOPDIR)/rules.mk
LUCI_TITLE:=æ ‹ä»”ä¸»é¢˜
PKG_VERSION:=1.0
PKG_RELEASE:=1
include $(INCLUDE_DIR)/package.mk
define Package/luci-theme-dongzhai
  $(call Package/luci/webtemplate)
  TITLE:=æ ‹ä»”ä¸»é¢˜
endef
define Build/Configure
endef
define Build/Compile
endef
define Package/luci-theme-dongzhai/install
	$(INSTALL_DIR) $(1)/www/luci-static/dongzhai
endef
$(eval $(call BuildPackage,luci-theme-dongzhai))
EOF
        
        echo "ä¸»é¢˜éƒ¨ç½²å®Œæˆ"

    - name: âš™ï¸ åº”ç”¨é…ç½®
      run: |
        cd lede
        cp ../.config .config
        
        # å¼ºåˆ¶ç¦ç”¨æ‰€æœ‰nodeç›¸å…³é…ç½®
        grep -v "CONFIG_PACKAGE_node" .config > .config.tmp
        mv .config.tmp .config
        echo "# CONFIG_PACKAGE_node is not set" >> .config
        echo "# CONFIG_PACKAGE_node-npm is not set" >> .config
        echo "# CONFIG_PACKAGE_node-yarn is not set" >> .config
        
        echo "CONFIG_PACKAGE_luci-theme-dongzhai=y" >> .config
        echo "CONFIG_DEFAULT_luci-theme-dongzhai=y" >> .config
        
        make defconfig
        echo "é…ç½®åº”ç”¨å®Œæˆ"

    - name: ğŸ“¦ ä¸‹è½½è½¯ä»¶åŒ…
      run: |
        cd lede
        make download -j1
        echo "è½¯ä»¶åŒ…ä¸‹è½½å®Œæˆ"

    - name: ğŸ”¨ ç¼–è¯‘å›ºä»¶
      run: |
        cd lede
        echo "å¼€å§‹ç¼–è¯‘..."
        make -j1 V=s
        echo "ç¼–è¯‘å®Œæˆ"

    - name: ğŸ“¤ ä¸Šä¼ ç»“æœ
      uses: actions/upload-artifact@v4
      with:
        name: æ ‹ä»”å›ºä»¶
        path: lede/bin/targets/**/*.bin
        retention-days: 30

    - name: âœ… å®Œæˆæç¤º
      run: |
        echo "ç¼–è¯‘å®Œæˆ"
