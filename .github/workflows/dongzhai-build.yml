name: æ ‹ä»”ä¸»é¢˜å®Œæ•´ç¼–è¯‘

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'ç‰ˆæœ¬ç±»å‹'
        required: true
        default: 'stable'
        type: choice
        options:
        - stable
        - dev

env:
  REPO_URL: https://github.com/coolsnowwolf/lede

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 240

    steps:
    - name: æ£€æŸ¥ä»£ç å’Œé…ç½®
      uses: actions/checkout@v4

    - name: éªŒè¯å¿…è¦æ–‡ä»¶
      run: |
        echo "ğŸ” æ£€æŸ¥å¿…è¦æ–‡ä»¶..."
        if [ ! -f ".config" ]; then
          echo "âŒ é”™è¯¯ï¼šç¼ºå°‘ .config æ–‡ä»¶"
          echo "è¯·åœ¨ä»“åº“æ ¹ç›®å½•åˆ›å»º .config æ–‡ä»¶"
          exit 1
        fi
        echo "âœ… æ‰¾åˆ° .config æ–‡ä»¶"
        
        echo "ğŸ“‹ é…ç½®æ‘˜è¦:"
        grep -E "CONFIG_TARGET|CONFIG_PACKAGE_luci" .config | head -10

    - name: å®‰è£…ç¼–è¯‘ç¯å¢ƒ
      run: |
        echo "ğŸ› ï¸ å®‰è£…ç¼–è¯‘å·¥å…·..."
        sudo apt-get update
        sudo apt-get install -y build-essential asciidoc binutils bzip2 gawk gettext git libncurses5-dev libz-dev patch python3 python3-pip unzip zlib1g-dev lib32gcc-s1 libc6-dev-i386 subversion flex uglifyjs git-core gcc-multilib p7zip p7zip-full msmtp libssl-dev texinfo libglib2.0-dev xmlto qemu-utils upx libelf-dev autoconf automake libtool autopoint device-tree-compiler g++-multilib antlr3 gperf wget curl swig rsync
        echo "âœ… ç¼–è¯‘ç¯å¢ƒå®‰è£…å®Œæˆ"

    - name: å…‹éš†Leanæºç 
      run: |
        echo "ğŸ“¥ å…‹éš† Lean çš„ OpenWrt æºç ..."
        git clone $REPO_URL lede
        cd lede
        echo "âœ… æºç å…‹éš†å®Œæˆ"

    - name: æ›´æ–°è½¯ä»¶æº
      run: |
        cd lede
        echo "ğŸ”„ æ›´æ–°è½¯ä»¶æº..."
        ./scripts/feeds update -a
        ./scripts/feeds install -a
        echo "âœ… è½¯ä»¶æºæ›´æ–°å®Œæˆ"

    - name: éƒ¨ç½²æ ‹ä»”ä¸»é¢˜
      run: |
        cd lede
        echo "ğŸ¨ éƒ¨ç½²æ ‹ä»”ä¸ªæ€§åŒ–ä¸»é¢˜..."
        
        # åˆ›å»ºä¸»é¢˜ç›®å½•
        mkdir -p package/lean/dongzhai-theme/luci-theme-dongzhai
        
        # å¤åˆ¶ä¸»é¢˜æ–‡ä»¶ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
        if [ -d "../.github/themes/dongzhai" ]; then
          echo "å¤åˆ¶ä¸»é¢˜æ–‡ä»¶..."
          cp -r ../.github/themes/dongzhai/* package/lean/dongzhai-theme/
        fi
        
        # åˆ›å»ºä¸»é¢˜çš„Makefile
        cat > package/lean/dongzhai-theme/luci-theme-dongzhai/Makefile << 'EOF'
include $(TOPDIR)/rules.mk

LUCI_TITLE:=æ ‹ä»”ä¸ªæ€§åŒ–ä¸»é¢˜
LUCI_DEPENDS:=
PKG_VERSION:=1.0
PKG_RELEASE:=1

include $(INCLUDE_DIR)/package.mk

define Package/luci-theme-dongzhai
  $(call Package/luci/webtemplate)
  TITLE:=æ ‹ä»”ä¸ªæ€§åŒ–ä¸»é¢˜
  DEPENDS:=+luci-compat
endef

define Package/luci-theme-dongzhai/description
  åŸºäºDesignä¸»é¢˜ä¿®æ”¹çš„æ ‹ä»”ä¸ªæ€§åŒ–ä¸»é¢˜
endef

define Build/Configure
endef

define Build/Compile
endef

define Package/luci-theme-dongzhai/install
	$(INSTALL_DIR) $(1)/www/luci-static/dongzhai
	[ -d ./files ] && $(CP) ./files/* $(1)/www/luci-static/dongzhai/
endef

$(eval $(call BuildPackage,luci-theme-dongzhai))
EOF

        echo "âœ… æ ‹ä»”ä¸»é¢˜éƒ¨ç½²å®Œæˆ"

    - name: åº”ç”¨é…ç½®
      run: |
        cd lede
        echo "âš™ï¸ åº”ç”¨ç¼–è¯‘é…ç½®..."
        
        # å¤åˆ¶ç”¨æˆ·é…ç½®æ–‡ä»¶
        cp ../.config .config
        
        # ç¡®ä¿æ ‹ä»”ä¸»é¢˜è¢«å¯ç”¨
        if ! grep -q "CONFIG_PACKAGE_luci-theme-dongzhai=y" .config; then
          echo "æ·»åŠ æ ‹ä»”ä¸»é¢˜é…ç½®..."
          echo "" >> .config
          echo "# æ ‹ä»”ä¸ªæ€§åŒ–ä¸»é¢˜" >> .config
          echo "CONFIG_PACKAGE_luci-theme-dongzhai=y" >> .config
        fi
        
        # è®¾ç½®é»˜è®¤ä¸»é¢˜
        if grep -q "CONFIG_PACKAGE_luci=y" .config; then
          sed -i '/CONFIG_DEFAULT_luci-theme/d' .config
          echo "CONFIG_DEFAULT_luci-theme-dongzhai=y" >> .config
        fi
        
        make defconfig
        echo "âœ… é…ç½®åº”ç”¨å®Œæˆ"

    - name: ä¸‹è½½è½¯ä»¶åŒ…
      run: |
        cd lede
        echo "ğŸ“¦ ä¸‹è½½è½¯ä»¶åŒ…..."
        make download -j$(nproc)
        echo "âœ… è½¯ä»¶åŒ…ä¸‹è½½å®Œæˆ"

    - name: ç¼–è¯‘å›ºä»¶
      run: |
        cd lede
        echo "ğŸ”¨ å¼€å§‹ç¼–è¯‘å›ºä»¶..."
        echo "â° è¿™å¯èƒ½éœ€è¦ 2-4 å°æ—¶ï¼Œè¯·è€å¿ƒç­‰å¾…..."
        echo "ğŸ“Š ä½¿ç”¨ $(($(nproc) / 2 + 1)) ä¸ªçº¿ç¨‹ç¼–è¯‘..."
        make -j$(($(nproc) / 2 + 1)) || make -j1
        echo "âœ… ç¼–è¯‘å®Œæˆ"

    - name: æ”¶é›†ç¼–è¯‘ç»“æœ
      id: collect_results
      run: |
        cd lede/bin/targets
        echo "ğŸ” æŸ¥æ‰¾ç”Ÿæˆçš„å›ºä»¶..."
        
        FIRMWARE_FILES=$(find . -name "*.bin" -type f)
        if [ -n "$FIRMWARE_FILES" ]; then
          echo "ğŸ‰ æ‰¾åˆ°å›ºä»¶æ–‡ä»¶:"
          for file in $FIRMWARE_FILES; do
            size=$(du -h "$file" | cut -f1)
            echo "   ğŸ“„ $file ($size)"
          done
          
          # æå–è®¾å¤‡ä¿¡æ¯
          FIRST_FILE=$(echo "$FIRMWARE_FILES" | head -1)
          DEVICE_INFO=$(echo "$FIRMWARE_FILES" | head -1 | grep -o 'targets/[^/]*/[^/]*' | cut -d'/' -f2-3 | tr '/' '_')
          
          echo "has_firmware=true" >> $GITHUB_OUTPUT
          echo "firmware_count=$(echo "$FIRMWARE_FILES" | wc -w)" >> $GITHUB_OUTPUT
          echo "device_info=$DEVICE_INFO" >> $GITHUB_ENV
        else
          echo "âŒ æœªæ‰¾åˆ°å›ºä»¶æ–‡ä»¶"
          echo "has_firmware=false" >> $GITHUB_OUTPUT
        fi

    - name: ä¸Šä¼ å›ºä»¶åˆ°Artifacts
      if: steps.collect_results.outputs.has_firmware == 'true'
      uses: actions/upload-artifact@v4
      with:
        name: æ ‹ä»”ä¸»é¢˜å›ºä»¶_${{ env.device_info }}_${{ github.event.inputs.version }}
        path: lede/bin/targets/**/*.bin
        retention-days: 30

    - name: åˆ›å»ºRelease
      if: steps.collect_results.outputs.has_firmware == 'true'
      uses: softprops/action-gh-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: dongzhai-${{ env.device_info }}-${{ github.event.inputs.version }}-$(date +%Y%m%d)
        name: æ ‹ä»”ä¸»é¢˜å›ºä»¶ ${{ github.event.inputs.version }}
        body: |
          # ğŸ  æ ‹ä»”ä¸»é¢˜ä¸ªæ€§åŒ–å›ºä»¶
          
          ## ç¼–è¯‘ä¿¡æ¯
          - **ç‰ˆæœ¬**: ${{ github.event.inputs.version }}
          - **è®¾å¤‡**: ${{ env.device_info }}
          - **æ—¶é—´**: $(date)
          - **æºç **: Lean's OpenWrt
          
          ## ç‰¹è‰²åŠŸèƒ½
          - ğŸ¨ æ ‹ä»”ä¸ªæ€§åŒ–ä¸»é¢˜ç•Œé¢
          - ğŸš€ ä¼˜åŒ–çš„ç”¨æˆ·ä½“éªŒ
          - ğŸ“± è‰¯å¥½çš„ç§»åŠ¨ç«¯æ”¯æŒ
          
          ## ä½¿ç”¨è¯´æ˜
          1. ä¸‹è½½å¯¹åº”çš„å›ºä»¶æ–‡ä»¶
          2. é€šè¿‡è·¯ç”±å™¨ç®¡ç†ç•Œé¢åˆ·å…¥
          3. äº«å—ä¸ªæ€§åŒ–ä½“éªŒï¼
        files: lede/bin/targets/**/*.bin
        draft: false
        prerelease: ${{ github.event.inputs.version == 'dev' }}

    - name: ç¼–è¯‘å®Œæˆæ€»ç»“
      if: always()
      run: |
        echo ""
        echo "=========================================="
        echo "           ğŸ ç¼–è¯‘ä»»åŠ¡å®Œæˆ"
        echo "=========================================="
        if [ "${{ success() }}" = "true" ]; then
          if [ "${{ steps.collect_results.outputs.has_firmware }}" = "true" ]; then
            echo "âœ… ç¼–è¯‘æˆåŠŸï¼"
            echo "ğŸ“¦ ç”Ÿæˆ ${{ steps.collect_results.outputs.firmware_count }} ä¸ªå›ºä»¶æ–‡ä»¶"
            echo "ğŸ·ï¸ è®¾å¤‡å¹³å°: ${{ env.device_info }}"
            echo "ğŸ”– ç‰ˆæœ¬ç±»å‹: ${{ github.event.inputs.version }}"
            echo ""
            echo "ğŸ“¥ ä¸‹è½½ä½ç½®:"
            echo "   - Releases é¡µé¢"
            echo "   - Actions â†’ Artifacts"
          else
            echo "âš ï¸ ç¼–è¯‘è¿‡ç¨‹å®Œæˆä½†æœªæ‰¾åˆ°å›ºä»¶æ–‡ä»¶"
            echo "è¯·æ£€æŸ¥ç¼–è¯‘æ—¥å¿—äº†è§£è¯¦æƒ…"
          fi
        else
          echo "âŒ ç¼–è¯‘å¤±è´¥ï¼"
          echo "è¯·æŸ¥çœ‹é”™è¯¯æ—¥å¿—å¹¶ä¿®æ­£é—®é¢˜"
        fi
        echo "=========================================="
