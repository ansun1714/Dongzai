name: OpenWrtæ™ºèƒ½ç¼–è¯‘ï¼ˆç½‘ç»œä¼˜åŒ–ç‰ˆï¼‰

on:
  workflow_dispatch:
    inputs:
      compile_threads:
        description: 'ç¼–è¯‘çº¿ç¨‹æ•°ï¼ˆæ¨èï¼š2-4ï¼‰'
        required: false
        default: '2'
        type: choice
        options:
          - '1'
          - '2'
          - '3'
          - '4'
      skip_problem_packages:
        description: 'è‡ªåŠ¨è·³è¿‡å·²çŸ¥é—®é¢˜åŒ…'
        required: false
        default: 'true'
        type: boolean
      clean_build:
        description: 'æ¸…ç†ç¼“å­˜é‡æ–°ç¼–è¯‘'
        required: false
        default: 'false'
        type: boolean

env:
  REPO_URL: https://github.com/coolsnowwolf/lede
  BUILD_DIR: /builder/openwrt-build
  DL_DIR: /builder/dl-cache
  CCACHE_DIR: /builder/ccache
  WORKER_NAME: ${{ github.run_id }}-${{ github.run_attempt }}
  
  # é•œåƒæºé…ç½®
  OPENWRT_MIRRORS: |
    https://mirror.fsfe.org/openwrt
    https://openwrt.mirror.constant.com
    https://openwrt.mirror.datarouter.de
    https://mirror2.openwrt.org
    https://sources.openwrt.org
    https://github.com/openwrt

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 480
    
    steps:
    # ========== é˜¶æ®µ1ï¼šåˆå§‹åŒ–ä¸éªŒè¯ ==========
    - name: æ£€æŸ¥å·¥ä½œç©ºé—´
      run: |
        echo "=== ç¼–è¯‘ç¯å¢ƒä¿¡æ¯ ==="
        echo "å·¥ä½œæµ: ${{ github.workflow }}"
        echo "è¿è¡ŒID: ${{ github.run_id }}"
        echo "Runner: ${{ runner.os }} ${{ runner.arch }}"
        echo "å†…æ ¸: $(uname -r)"
        echo "å†…å­˜: $(free -h | awk '/^Mem:/ {print $2}')"
        echo "CPU: $(nproc) æ ¸å¿ƒ"
        echo "ç£ç›˜:"
        df -h
        echo "================================="

    - name: æ£€å‡ºä»“åº“ä»£ç 
      uses: actions/checkout@v4
      with:
        fetch-depth: 1
        submodules: recursive

    - name: é…ç½®æ–‡ä»¶éªŒè¯
      id: config_check
      run: |
        echo "=== é…ç½®æ–‡ä»¶éªŒè¯ ==="
        
        # æ£€æŸ¥å¿…è¦çš„é…ç½®æ–‡ä»¶
        REQUIRED_FILES=(".config")
        MISSING_FILES=()
        
        for file in "${REQUIRED_FILES[@]}"; do
          if [ ! -f "$file" ]; then
            MISSING_FILES+=("$file")
            echo "âŒ ç¼ºå°‘å¿…éœ€æ–‡ä»¶: $file"
          else
            echo "âœ… æ‰¾åˆ°æ–‡ä»¶: $file ($(wc -l < "$file") è¡Œ)"
          fi
        done
        
        if [ ${#MISSING_FILES[@]} -gt 0 ]; then
          echo "é”™è¯¯ï¼šç¼ºå°‘ä»¥ä¸‹å¿…éœ€æ–‡ä»¶: ${MISSING_FILES[*]}"
          exit 1
        fi
        
        # æ£€æŸ¥feedé…ç½®æ–‡ä»¶
        FEED_FILES=("feeds.conf.default" "feed.conf.default")
        FEED_FOUND=false
        
        for feed_file in "${FEED_FILES[@]}"; do
          if [ -f "$feed_file" ]; then
            echo "âœ… æ‰¾åˆ°feedé…ç½®: $feed_file"
            FEED_FOUND=true
            break
          fi
        done
        
        if [ "$FEED_FOUND" = false ]; then
          echo "âš ï¸ æœªæ‰¾åˆ°feedé…ç½®æ–‡ä»¶ï¼Œå°†ä½¿ç”¨é»˜è®¤é…ç½®"
        fi
        
        # åˆ†æ.configæ–‡ä»¶
        echo "=== é…ç½®åˆ†æ ==="
        if command -v python3 &> /dev/null; then
          python3 << 'EOF'
import re
try:
    with open('.config', 'r') as f:
        content = f.read()
    
    packages = re.findall(r'CONFIG_PACKAGE_(.+?)=y', content)
    print(f"å¯ç”¨çš„è½¯ä»¶åŒ…æ•°é‡: {len(packages)}")
    
    # ç»Ÿè®¡å¸¸è§é—®é¢˜åŒ…
    problem_packages = ['rpcd', 'luci', 'docker', 'qemu']
    for pkg in problem_packages:
        if f'CONFIG_PACKAGE_{pkg}=y' in content:
            print(f"âš ï¸  æ£€æµ‹åˆ°å¯èƒ½çš„é—®é¢˜åŒ…: {pkg}")
            
    # æ£€æŸ¥æ¶æ„
    arch_match = re.search(r'CONFIG_TARGET_(.+?)=y', content)
    if arch_match:
        print(f"ç›®æ ‡æ¶æ„: {arch_match.group(1)}")
        
except Exception as e:
    print(f"é…ç½®åˆ†æå¤±è´¥: {e}")
EOF
        else
          echo "âš ï¸ Python3æœªå®‰è£…ï¼Œè·³è¿‡é…ç½®åˆ†æ"
        fi
        
        echo "config_valid=true" >> $GITHUB_OUTPUT
        echo "feed_found=$FEED_FOUND" >> $GITHUB_OUTPUT

    # ========== é˜¶æ®µ2ï¼šç¯å¢ƒå‡†å¤‡ ==========
    - name: åˆ›å»ºç¼–è¯‘å·¥ä½œç©ºé—´
      run: |
        echo "=== åˆ›å»ºç¼–è¯‘å·¥ä½œç©ºé—´ ==="
        
        # æ¸…ç†æ—§çš„å·¥ä½œç©ºé—´ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
        sudo umount /builder 2>/dev/null || true
        sudo rm -f /mnt/openwrt.img 2>/dev/null || true
        
        # åˆ›å»ºè™šæ‹Ÿç£ç›˜ï¼ˆ40GBï¼Œæ ¹æ®ç¼–è¯‘è§„æ¨¡è°ƒæ•´ï¼‰
        DISK_SIZE=40960  # 40GB in MB
        echo "åˆ›å»º ${DISK_SIZE}MB è™šæ‹Ÿç£ç›˜..."
        sudo dd if=/dev/zero of=/mnt/openwrt.img bs=1M count=$DISK_SIZE status=progress
        sudo mkfs.ext4 -F /mnt/openwrt.img
        
        # æŒ‚è½½å·¥ä½œç©ºé—´
        sudo mkdir -p /builder
        sudo mount /mnt/openwrt.img /builder
        sudo chown -R runner:runner /builder
        sudo chmod -R 755 /builder
        
        echo "âœ… å·¥ä½œç©ºé—´åˆ›å»ºå®Œæˆ"
        df -h /builder
        echo "å·¥ä½œç©ºé—´æƒé™:"
        ls -ld /builder

    - name: å®‰è£…ç¼–è¯‘ç¯å¢ƒ
      timeout-minutes: 15
      run: |
        echo "=== å®‰è£…ç¼–è¯‘ç¯å¢ƒ ==="
        
        # æ›´æ–°è½¯ä»¶æº
        sudo sed -i 's/archive.ubuntu.com/mirrors.aliyun.com/g' /etc/apt/sources.list
        sudo sed -i 's/security.ubuntu.com/mirrors.aliyun.com/g' /etc/apt/sources.list
        
        # å®‰è£…åŸºç¡€ç¼–è¯‘å·¥å…·
        sudo DEBIAN_FRONTEND=noninteractive apt-get update
        sudo DEBIAN_FRONTEND=noninteractive apt-get install -y \
          build-essential ccache cmake curl file g++ gawk gcc git \
          libncurses5-dev libssl-dev make python3 python3-pip rsync \
          unzip wget zlib1g-dev bison flex automake autoconf \
          libtool-bin pkg-config gettext texinfo subversion \
          gperf jq upx xxd bc lzop cpio squashfs-tools \
          dosfstools mtools uuid-runtime qemu-utils \
          libelf-dev patchelf zstd
        
        # å®‰è£…Pythonä¾èµ–
        pip3 install --upgrade pip -i https://pypi.tuna.tsinghua.edu.cn/simple
        pip3 install requests beautifulsoup4 lxml -i https://pypi.tuna.tsinghua.edu.cn/simple
        
        # é…ç½®ccache
        mkdir -p "${{ env.CCACHE_DIR }}"
        echo "max_size = 5G" > "${{ env.CCACHE_DIR }}/ccache.conf"
        
        echo "âœ… ç¼–è¯‘ç¯å¢ƒå®‰è£…å®Œæˆ"
        echo "ccacheç‰ˆæœ¬: $(ccache --version | head -1)"

    # ========== é˜¶æ®µ3ï¼šæºç å‡†å¤‡ ==========
    - name: å…‹éš†OpenWrtæºç 
      timeout-minutes: 10
      run: |
        cd /builder
        echo "=== å…‹éš†OpenWrtæºç  ==="
        
        # æ¸…ç†æ—§æºç ï¼ˆå¦‚æœclean_buildä¸ºtrueï¼‰
        if [ "${{ inputs.clean_build }}" = "true" ]; then
          echo "æ¸…ç†æ¨¡å¼ï¼šåˆ é™¤æ—§æºç ..."
          rm -rf openwrt-build dl-cache ccache
        fi
        
        # å¦‚æœå·²æœ‰æºç ï¼Œæ›´æ–°è€Œä¸æ˜¯é‡æ–°å…‹éš†
        if [ -d "openwrt-build/.git" ]; then
          echo "å·²æœ‰æºç ï¼Œå°è¯•æ›´æ–°..."
          cd openwrt-build
          git fetch --depth=1 origin
          git reset --hard origin/master
          cd ..
        else
          echo "å…‹éš†æ–°æºç ..."
          git clone --depth=1 --single-branch --branch master \
            "${{ env.REPO_URL }}" openwrt-build
        fi
        
        echo "âœ… æºç å‡†å¤‡å®Œæˆ"
        echo "æºç ç›®å½•å¤§å°: $(du -sh openwrt-build | cut -f1)"

    - name: åº”ç”¨é…ç½®å’Œä¿®å¤ç½‘ç»œ
      id: apply_config
      run: |
        cd "${{ env.BUILD_DIR }}"
        echo "=== åº”ç”¨é…ç½®å’Œä¿®å¤ç½‘ç»œ ==="
        
        # å¤‡ä»½åŸå§‹é…ç½®
        cp -f feeds.conf.default feeds.conf.default.backup 2>/dev/null || true
        
        # åº”ç”¨ç”¨æˆ·é…ç½®
        echo "1. åº”ç”¨é…ç½®æ–‡ä»¶..."
        cp -f "${{ github.workspace }}/.config" .config
        
        # å¤„ç†feedé…ç½®æ–‡ä»¶
        if [ -f "${{ github.workspace }}/feeds.conf.default" ]; then
          cp -f "${{ github.workspace }}/feeds.conf.default" .
        elif [ -f "${{ github.workspace }}/feed.conf.default" ]; then
          cp -f "${{ github.workspace }}/feed.conf.default" .
          mv -f feed.conf.default feeds.conf.default
        fi
        
        # ä¼˜åŒ–ç½‘ç»œé…ç½®
        echo "2. ä¼˜åŒ–ç½‘ç»œé…ç½®..."
        
        # æ›¿æ¢ä¸ºå›½å†…é•œåƒæºï¼ˆå¤§å¹…æå‡ä¸‹è½½é€Ÿåº¦ï¼‰
        if grep -q "github.com" feeds.conf.default 2>/dev/null; then
          echo "ä½¿ç”¨å›½å†…é•œåƒæºä¼˜åŒ–..."
          sed -i \
            -e 's|github.com|hub.fastgit.xyz|g' \
            -e 's|git.openwrt.org|github.com/openwrt|g' \
            -e 's|git://|https://|g' \
            feeds.conf.default 2>/dev/null || true
        fi
        
        # åˆ›å»ºæ™ºèƒ½ä¸‹è½½ç®¡ç†å™¨
        echo "3. åˆ›å»ºæ™ºèƒ½ä¸‹è½½ç®¡ç†å™¨..."
        cat > download-manager.sh << 'EOF'
#!/bin/bash
# OpenWrtæ™ºèƒ½ä¸‹è½½ç®¡ç†å™¨ v2.0

set -euo pipefail

URL="$1"
OUTPUT="$2"
FILENAME=$(basename "$URL")
MAX_RETRIES=5
TIMEOUT=45

echo "ğŸš€ å¼€å§‹ä¸‹è½½: $FILENAME"

# å‡½æ•°ï¼šè®°å½•æ—¥å¿—
log() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" >> /tmp/download.log
}

# å‡½æ•°ï¼šæ£€æŸ¥ç¼“å­˜
check_cache() {
    if [ -f "${{ env.DL_DIR }}/$FILENAME" ]; then
        local cache_size=$(stat -c%s "${{ env.DL_DIR }}/$FILENAME" 2>/dev/null || echo 0)
        if [ "$cache_size" -gt 1024 ]; then
            echo "âœ… ä½¿ç”¨ç¼“å­˜æ–‡ä»¶ (${cache_size} bytes)"
            log "HIT: $FILENAME"
            cp "${{ env.DL_DIR }}/$FILENAME" "$OUTPUT"
            return 0
        else
            rm -f "${{ env.DL_DIR }}/$FILENAME"
        fi
    fi
    return 1
}

# å‡½æ•°ï¼šä¸‹è½½æ–‡ä»¶
download_file() {
    local url="$1"
    local output="$2"
    local retry_count=0
    
    while [ $retry_count -lt $MAX_RETRIES ]; do
        retry_count=$((retry_count + 1))
        
        echo "  å°è¯• $retry_count/$MAX_RETRIES: $url"
        
        # ä½¿ç”¨wgetï¼ˆæ›´å¥½çš„æ–­ç‚¹ç»­ä¼ ï¼‰
        if wget --timeout=$TIMEOUT --tries=1 --retry-connrefused \
                --progress=dot:giga --show-progress \
                -O "$output.tmp" "$url" 2>&1 | tail -5; then
            mv "$output.tmp" "$output"
            log "SUCCESS: $FILENAME from $url"
            return 0
        fi
        
        echo "  ä¸‹è½½å¤±è´¥ï¼Œç­‰å¾…é‡è¯•..."
        sleep $((retry_count * 2))
    done
    
    log "FAILED: $FILENAME after $MAX_RETRIES attempts"
    return 1
}

# ä¸»é€»è¾‘
main() {
    # é¦–å…ˆæ£€æŸ¥ç¼“å­˜
    if check_cache; then
        return 0
    fi
    
    # åˆ›å»ºä¸‹è½½ç›®å½•
    mkdir -p "${{ env.DL_DIR }}"
    
    # æ ¹æ®æ–‡ä»¶ç±»å‹é€‰æ‹©é•œåƒæº
    case "$FILENAME" in
        *.tar.xz|*.tar.gz|*.tar.bz2|*.zip|*.tgz)
            # OpenWrtæºç æ–‡ä»¶ï¼Œä½¿ç”¨é•œåƒæº
            local mirrors=(
                "https://mirror.fsfe.org/openwrt/sources/$FILENAME"
                "https://openwrt.mirror.constant.com/sources/$FILENAME"
                "https://openwrt.mirror.datarouter.de/sources/$FILENAME"
                "https://sources.openwrt.org/$FILENAME"
                "https://mirror2.openwrt.org/sources/$FILENAME"
                "$URL"
            )
            
            # å¦‚æœæ˜¯å›½å†…ç¯å¢ƒï¼Œä¼˜å…ˆä½¿ç”¨å›½å†…é•œåƒ
            if ping -c 1 -W 1 mirrors.tuna.tsinghua.edu.cn &>/dev/null; then
                mirrors=(
                    "https://mirrors.tuna.tsinghua.edu.cn/openwrt/sources/$FILENAME"
                    "https://mirrors.ustc.edu.cn/openwrt/sources/$FILENAME"
                    "https://mirror.fsfe.org/openwrt/sources/$FILENAME"
                    "${mirrors[@]}"
                )
            fi
            
            for mirror_url in "${mirrors[@]}"; do
                if download_file "$mirror_url" "$OUTPUT"; then
                    # ç¼“å­˜æˆåŠŸä¸‹è½½çš„æ–‡ä»¶
                    cp "$OUTPUT" "${{ env.DL_DIR }}/$FILENAME" 2>/dev/null || true
                    return 0
                fi
            done
            ;;
            
        *)
            # å…¶ä»–æ–‡ä»¶ç›´æ¥ä¸‹è½½
            if download_file "$URL" "$OUTPUT"; then
                cp "$OUTPUT" "${{ env.DL_DIR }}/$FILENAME" 2>/dev/null || true
                return 0
            fi
            ;;
    esac
    
    echo "âŒ æ‰€æœ‰ä¸‹è½½å°è¯•éƒ½å¤±è´¥: $FILENAME"
    
    # ç‰¹æ®Šå¤„ç†ï¼šå°è¯•GitHubå¤‡ç”¨æ–¹æ¡ˆ
    if [[ "$URL" == *"github.com"* ]] && [[ "$FILENAME" == *".tar.gz" || "$FILENAME" == *".zip" ]]; then
        echo "ğŸ”„ å°è¯•GitHubå¤‡ç”¨æ–¹æ¡ˆ..."
        local repo=$(echo "$URL" | sed -n 's|.*github.com/\([^/]*/[^/]*\).*|\1|p')
        local tag=$(echo "$URL" | sed -n 's|.*/\(v\?[0-9.]*\)\.tar\.gz|\1|p' | sed 's/\.tar\.gz$//')
        
        if [ -n "$repo" ] && [ -n "$tag" ]; then
            local github_api="https://api.github.com/repos/$repo/releases/tags/$tag"
            local download_url=$(curl -s "$github_api" | grep -o '"browser_download_url": "[^"]*' | head -1 | cut -d'"' -f4)
            
            if [ -n "$download_url" ] && download_file "$download_url" "$OUTPUT"; then
                cp "$OUTPUT" "${{ env.DL_DIR }}/$FILENAME"
                echo "âœ… é€šè¿‡GitHub APIä¸‹è½½æˆåŠŸ"
                return 0
            fi
        fi
    fi
    
    return 1
}

# æ‰§è¡Œä¸»å‡½æ•°
if main; then
    exit 0
else
    # å¦‚æœæ˜¯ç‰¹å®šåŒ…ï¼Œå°è¯•å¤‡ç”¨æ–¹æ¡ˆ
    if [[ "$FILENAME" == *rpcd* ]]; then
        echo "ğŸ› ï¸ å°è¯•rpcdå¤‡ç”¨æ–¹æ¡ˆ..."
        cat > /tmp/rpcd-fix.sh << 'RPCDEOF'
#!/bin/bash
# rpcdåŒ…ç‰¹æ®Šå¤„ç†
TEMP_DIR=$(mktemp -d)
cd "$TEMP_DIR"

echo "ä»GitHubè·å–æœ€æ–°rpcd..."
git clone --depth=1 https://github.com/openwrt/rpcd.git 2>/dev/null || \
git clone --depth=1 https://hub.fastgit.xyz/openwrt/rpcd.git 2>/dev/null || {
    echo "å…‹éš†å¤±è´¥ï¼Œä½¿ç”¨æœ¬åœ°ç”Ÿæˆ"
    mkdir -p rpcd
    echo '#!/bin/sh' > rpcd/rpcd
    chmod +x rpcd/rpcd
}

tar -cJf "${{ env.DL_DIR }}/$FILENAME" -C rpcd .
cp "${{ env.DL_DIR }}/$FILENAME" "$OUTPUT"
rm -rf "$TEMP_DIR"
echo "âœ… rpcdåŒ…ç”Ÿæˆå®Œæˆ"
exit 0
RPCDEOF
        bash /tmp/rpcd-fix.sh && exit 0
        rm -f /tmp/rpcd-fix.sh
    fi
    
    exit 1
fi
EOF

        chmod +x download-manager.sh
        
        # åˆ›å»ºé—®é¢˜åŒ…è·³è¿‡ç¨‹åº
        if [ "${{ inputs.skip_problem_packages }}" = "true" ]; then
          echo "4. åˆ›å»ºé—®é¢˜åŒ…è·³è¿‡ç¨‹åº..."
          cat > skip-problem-packages.sh << 'EOF'
#!/bin/bash
# è‡ªåŠ¨è·³è¿‡å·²çŸ¥é—®é¢˜åŒ…

PROBLEM_PACKAGES=(
  "CONFIG_PACKAGE_rpcd=y"
  "CONFIG_PACKAGE_luci-app-docker=y"
  "CONFIG_PACKAGE_qemu=y"
  "CONFIG_PACKAGE_docker=y"
  "CONFIG_PACKAGE_dockerd=y"
)

CONFIG_FILE=".config"
BACKUP_FILE=".config.backup"

if [ ! -f "$CONFIG_FILE" ]; then
    echo "é…ç½®æ–‡ä»¶ä¸å­˜åœ¨"
    exit 1
fi

cp "$CONFIG_FILE" "$BACKUP_FILE"
SKIPPED=0

for pkg in "${PROBLEM_PACKAGES[@]}"; do
    if grep -q "^$pkg" "$CONFIG_FILE"; then
        echo "âš ï¸  è·³è¿‡é—®é¢˜åŒ…: $pkg"
        sed -i "s/^$pkg/# $pkg/" "$CONFIG_FILE"
        SKIPPED=$((SKIPPED + 1))
    fi
done

if [ $SKIPPED -gt 0 ]; then
    echo "å·²è·³è¿‡ $SKIPPED ä¸ªé—®é¢˜åŒ…"
    echo "å¤‡ä»½ä¿å­˜åœ¨: $BACKUP_FILE"
else
    echo "æœªæ£€æµ‹åˆ°å·²çŸ¥é—®é¢˜åŒ…"
    rm -f "$BACKUP_FILE"
fi
EOF
          chmod +x skip-problem-packages.sh
          ./skip-problem-packages.sh
        fi
        
        echo "âœ… é…ç½®åº”ç”¨å®Œæˆ"

    # ========== é˜¶æ®µ4ï¼šä¾èµ–å‡†å¤‡ ==========
    - name: åˆå§‹åŒ–OpenWrtç¯å¢ƒ
      timeout-minutes: 20
      run: |
        cd "${{ env.BUILD_DIR }}"
        echo "=== åˆå§‹åŒ–OpenWrtç¯å¢ƒ ==="
        
        # è®¾ç½®ç¯å¢ƒå˜é‡
        export PATH="$PWD:$PATH"
        export FORCE_UNSAFE_CONFIGURE=1
        
        # é…ç½®ccache
        export CCACHE_DIR="${{ env.CCACHE_DIR }}"
        export CCACHE_MAXSIZE="5G"
        ccache -z
        
        # æ¸…ç†æ—§é“¾æ¥
        rm -rf dl
        ln -sf "${{ env.DL_DIR }}" dl
        
        # æ›´æ–°feeds
        echo "1. æ›´æ–°feeds..."
        for i in {1..3}; do
          echo "å°è¯• $i/3"
          if ./scripts/feeds update -a; then
            echo "âœ… Feedsæ›´æ–°æˆåŠŸ"
            break
          elif [ $i -eq 3 ]; then
            echo "âŒ Feedsæ›´æ–°å¤±è´¥ï¼Œå°è¯•è·³è¿‡é”™è¯¯..."
            ./scripts/feeds update -a -f || true
          fi
          sleep 5
        done
        
        echo "2. å®‰è£…è½¯ä»¶åŒ…..."
        ./scripts/feeds install -a
        
        echo "3. éªŒè¯é…ç½®..."
        make defconfig
        
        # æ£€æŸ¥ç¼ºå¤±çš„ä¾èµ–
        echo "4. æ£€æŸ¥é…ç½®..."
        if make -s -i check 2>/tmp/make-check.log; then
          echo "âœ… é…ç½®æ£€æŸ¥é€šè¿‡"
        else
          echo "âš ï¸  é…ç½®æ£€æŸ¥å‘ç°è­¦å‘Š:"
          grep -i "warning\|error\|missing" /tmp/make-check.log | head -10 || true
        fi
        
        echo "âœ… ç¯å¢ƒåˆå§‹åŒ–å®Œæˆ"

    - name: é¢„ä¸‹è½½ä¾èµ–æ–‡ä»¶
      timeout-minutes: 30
      run: |
        cd "${{ env.BUILD_DIR }}"
        echo "=== é¢„ä¸‹è½½ä¾èµ–æ–‡ä»¶ ==="
        
        # ä½¿ç”¨æ™ºèƒ½ä¸‹è½½å™¨
        export PATH="$PWD:$PATH"
        
        echo "ä¸‹è½½å·¥å…·é“¾..."
        # å¹¶è¡Œä¸‹è½½ï¼Œä½†é™åˆ¶å¹¶å‘æ•°
        make tools/download -j${{ inputs.compile_threads }} V=sc || {
          echo "âš ï¸  å·¥å…·é“¾ä¸‹è½½éƒ¨åˆ†å¤±è´¥ï¼Œç»§ç»­..."
          # æ¸…ç†é”å®šæ–‡ä»¶
          find /tmp -name "*.flock" -type f -delete 2>/dev/null || true
        }
        
        # é¢„ä¸‹è½½å¸¸è§ä¾èµ–
        echo "é¢„ä¸‹è½½å¸¸è§ä¾èµ–åŒ…..."
        COMMON_DEPS=(
          "https://mirror.fsfe.org/openwrt/sources/rpcd-2024-12-02-cc9a471c.tar.xz"
          "https://mirror.fsfe.org/openwrt/sources/linux-6.6.tar.xz"
          "https://github.com/erofs/erofs-utils/archive/refs/tags/v1.8.10.tar.gz"
          "https://mirror.fsfe.org/openwrt/sources/cmake-3.28.3.tar.gz"
          "https://mirror.fsfe.org/openwrt/sources/ninja-1.11.1.tar.gz"
        )
        
        for dep in "${COMMON_DEPS[@]}"; do
          filename=$(basename "$dep")
          if [ ! -f "dl/$filename" ]; then
            echo "é¢„ä¸‹è½½: $filename"
            ./download-manager.sh "$dep" "dl/$filename" || true
          fi
        done
        
        echo "âœ… é¢„ä¸‹è½½å®Œæˆ"
        echo "ç¼“å­˜ç›®å½•ä¿¡æ¯:"
        du -sh dl || true
        echo "æ–‡ä»¶æ•°é‡: $(find dl -type f 2>/dev/null | wc -l || echo 0)"

    # ========== é˜¶æ®µ5ï¼šç¼–è¯‘è¿‡ç¨‹ ==========
    - name: ç¼–è¯‘å·¥å…·é“¾
      timeout-minutes: 120
      run: |
        cd "${{ env.BUILD_DIR }}"
        echo "=== ç¼–è¯‘å·¥å…·é“¾ ==="
        
        export FORCE_UNSAFE_CONFIGURE=1
        export CCACHE_DIR="${{ env.CCACHE_DIR }}"
        
        echo "ccacheç»Ÿè®¡:"
        ccache -s
        
        echo "å¼€å§‹ç¼–è¯‘å·¥å…·é“¾..."
        
        # æ™ºèƒ½ç¼–è¯‘å‡½æ•°
        compile_with_retry() {
          local target="$1"
          local max_retries=3
          local retry_count=0
          
          while [ $retry_count -lt $max_retries ]; do
            retry_count=$((retry_count + 1))
            echo "ç¼–è¯‘å°è¯• $retry_count/$max_retries: $target"
            
            if make "$target" -j${{ inputs.compile_threads }} V=s 2>&1 | tee "/tmp/compile-$(date +%s).log"; then
              echo "âœ… $target ç¼–è¯‘æˆåŠŸ"
              return 0
            else
              echo "âŒ $target ç¼–è¯‘å¤±è´¥"
              
              if [ $retry_count -eq $max_retries ]; then
                echo "å°è¯•å•çº¿ç¨‹ç¼–è¯‘..."
                if make "$target" -j1 V=s; then
                  echo "âœ… $target å•çº¿ç¨‹ç¼–è¯‘æˆåŠŸ"
                  return 0
                fi
              else
                echo "ç­‰å¾…10ç§’åé‡è¯•..."
                sleep 10
                
                # æ¸…ç†å¯èƒ½çš„é”å®šæ–‡ä»¶
                find /tmp -name "*.flock" -type f -delete 2>/dev/null || true
                rm -rf tmp .config.old 2>/dev/null || true
              fi
            fi
          done
          
          echo "âŒ $target ç¼–è¯‘æœ€ç»ˆå¤±è´¥"
          return 1
        }
        
        # ç¼–è¯‘å·¥å…·é“¾
        if compile_with_retry "tools/compile"; then
          echo "âœ… å·¥å…·é“¾ç¼–è¯‘å®Œæˆ"
        else
          echo "âš ï¸  å·¥å…·é“¾ç¼–è¯‘å¤±è´¥ï¼Œå°è¯•ç»§ç»­..."
        fi
        
        echo "ccacheç»Ÿè®¡ï¼ˆç¼–è¯‘åï¼‰:"
        ccache -s

    - name: ç¼–è¯‘ç›®æ ‡ç»„ä»¶
      timeout-minutes: 180
      run: |
        cd "${{ env.BUILD_DIR }}"
        echo "=== ç¼–è¯‘ç›®æ ‡ç»„ä»¶ ==="
        
        export FORCE_UNSAFE_CONFIGURE=1
        export CCACHE_DIR="${{ env.CCACHE_DIR }}"
        
        echo "ç£ç›˜ç©ºé—´æ£€æŸ¥:"
        df -h /builder
        
        echo "ç¼–è¯‘ç›®æ ‡å·¥å…·é“¾..."
        make toolchain/compile -j${{ inputs.compile_threads }} || {
          echo "âš ï¸  ç›®æ ‡å·¥å…·é“¾ç¼–è¯‘æœ‰é—®é¢˜ï¼Œè®°å½•æ—¥å¿—åç»§ç»­..."
          tail -50 /tmp/compile-*.log 2>/dev/null | grep -i "error\|fail" | head -20 || true
        }
        
        echo "ç¼–è¯‘ç›®æ ‡æ–‡ä»¶..."
        make target/compile -j${{ inputs.compile_threads }} || {
          echo "âš ï¸  ç›®æ ‡æ–‡ä»¶ç¼–è¯‘æœ‰é—®é¢˜ï¼Œç»§ç»­..."
        }
        
        echo "ç¼–è¯‘å†…æ ¸..."
        make target/linux/compile -j${{ inputs.compile_threads }} || {
          echo "âš ï¸  å†…æ ¸ç¼–è¯‘æœ‰é—®é¢˜ï¼Œç»§ç»­..."
        }
        
        echo "âœ… ç›®æ ‡ç»„ä»¶ç¼–è¯‘å°è¯•å®Œæˆ"

    - name: ç¼–è¯‘è½¯ä»¶åŒ…
      timeout-minutes: 150
      run: |
        cd "${{ env.BUILD_DIR }}"
        echo "=== ç¼–è¯‘è½¯ä»¶åŒ… ==="
        
        # æ£€æŸ¥ç£ç›˜ç©ºé—´
        echo "ç¼–è¯‘å‰ç£ç›˜ç©ºé—´:"
        df -h /builder
        
        # å¹¶è¡Œç¼–è¯‘è½¯ä»¶åŒ…
        echo "å¼€å§‹å¹¶è¡Œç¼–è¯‘è½¯ä»¶åŒ…..."
        
        # åˆ›å»ºç¼–è¯‘é˜Ÿåˆ—
        PACKAGE_LIST=$(grep '^CONFIG_PACKAGE_' .config | grep '=y$' | wc -l)
        echo "éœ€è¦ç¼–è¯‘çš„è½¯ä»¶åŒ…æ•°é‡: $PACKAGE_LIST"
        
        # ä½¿ç”¨makeçš„å¹¶è¡Œç¼–è¯‘
        if make package/compile -j${{ inputs.compile_threads }} 2>&1 | tee /tmp/package-compile.log; then
          echo "âœ… è½¯ä»¶åŒ…ç¼–è¯‘æˆåŠŸ"
        else
          echo "âš ï¸  è½¯ä»¶åŒ…ç¼–è¯‘é‡åˆ°é—®é¢˜"
          
          # åˆ†æå¤±è´¥åŸå› 
          echo "=== å¤±è´¥åˆ†æ ==="
          grep -i "error\|fail\|no rule" /tmp/package-compile.log | tail -30 || true
          
          # å°è¯•å•ç‹¬ç¼–è¯‘å¤±è´¥çš„åŒ…
          echo "å°è¯•ä¿®å¤ç¼–è¯‘..."
          make package/compile -j1 V=sc 2>&1 | tail -50 || true
        fi
        
        echo "ç¼–è¯‘åç£ç›˜ç©ºé—´:"
        df -h /builder

    - name: æœ€ç»ˆç¼–è¯‘ä¸æ‰“åŒ…
      id: compile_result
      timeout-minutes: 90
      run: |
        cd "${{ env.BUILD_DIR }}"
        echo "=== æœ€ç»ˆç¼–è¯‘ä¸æ‰“åŒ… ==="
        
        echo "å½“å‰ç›®å½•çŠ¶æ€:"
        ls -la bin/ 2>/dev/null || echo "binç›®å½•ä¸å­˜åœ¨"
        
        echo "æ‰§è¡Œæœ€ç»ˆç¼–è¯‘..."
        
        # æœ€ç»ˆç¼–è¯‘
        if make -j${{ inputs.compile_threads }} IGNORE_ERRORS=y 2>&1 | tee /tmp/final-compile.log; then
          echo "ğŸ‰ OpenWrtç¼–è¯‘æˆåŠŸï¼"
          COMPILE_SUCCESS=true
        else
          echo "âš ï¸  æœ€ç»ˆç¼–è¯‘é‡åˆ°é—®é¢˜ï¼Œå°è¯•å•çº¿ç¨‹..."
          if make -j1 V=s IGNORE_ERRORS=y; then
            echo "ğŸ‰ å•çº¿ç¨‹ç¼–è¯‘æˆåŠŸï¼"
            COMPILE_SUCCESS=true
          else
            echo "âŒ æœ€ç»ˆç¼–è¯‘å¤±è´¥"
            COMPILE_SUCCESS=false
          fi
        fi
        
        # æ— è®ºæˆåŠŸä¸å¦ï¼Œéƒ½å°è¯•æ”¶é›†ç»“æœ
        echo "=== ç»“æœæ”¶é›† ==="
        
        # æŸ¥æ‰¾æ‰€æœ‰å¯èƒ½çš„è¾“å‡ºæ–‡ä»¶
        find bin -type f \( -name "*.bin" -o -name "*.img" -o -name "*.gz" \
                          -o -name "*.tar" -o -name "*.zip" \) \
          2>/dev/null | while read file; do
          echo "ğŸ“„ æ‰¾åˆ°: $file ($(ls -lh "$file" | awk '{print $5}'))"
          echo "$file" >> /tmp/firmware_list.txt
        done
        
        if [ -f "/tmp/firmware_list.txt" ]; then
          echo "âœ… æ‰¾åˆ°å›ºä»¶æ–‡ä»¶"
          echo "firmware_found=true" >> $GITHUB_OUTPUT
        else
          echo "firmware_found=false" >> $GITHUB_OUTPUT
        fi
        
        echo "COMPILE_SUCCESS=$COMPILE_SUCCESS" >> $GITHUB_OUTPUT

    # ========== é˜¶æ®µ6ï¼šç»“æœå¤„ç† ==========
    - name: æ”¶é›†ç¼–è¯‘ç»“æœ
      if: always()
      run: |
        cd "${{ env.BUILD_DIR }}"
        echo "=== ç¼–è¯‘ç»“æœæŠ¥å‘Š ==="
        
        # åˆ›å»ºæŠ¥å‘Šç›®å½•
        REPORT_DIR="/tmp/openwrt-report-${{ github.run_id }}"
        mkdir -p "$REPORT_DIR"
        
        # æ”¶é›†å…³é”®æ—¥å¿—
        for log in /tmp/*.log; do
          if [ -f "$log" ]; then
            cp "$log" "$REPORT_DIR/"
          fi
        done
        
        # æ”¶é›†é…ç½®æ–‡ä»¶
        cp .config "$REPORT_DIR/config-final"
        cp feeds.conf.default "$REPORT_DIR/feeds-final" 2>/dev/null || true
        
        # ç”ŸæˆæŠ¥å‘Š
        cat > "$REPORT_DIR/report.md" << 'EOF'
# OpenWrt ç¼–è¯‘æŠ¥å‘Š

## ç¼–è¯‘ä¿¡æ¯
- å·¥ä½œæµ: ${{ github.workflow }}
- è¿è¡ŒID: ${{ github.run_id }}
- ç¼–è¯‘æ—¶é—´: $(date)
- è¿è¡Œç¯å¢ƒ: ${{ runner.os }} ${{ runner.arch }}

## ç³»ç»Ÿèµ„æº
- CPUæ ¸å¿ƒ: $(nproc)
- å†…å­˜: $(free -h | awk '/^Mem:/ {print $2}')
- ç£ç›˜ä½¿ç”¨: $(df -h /builder | tail -1)

## ç¼–è¯‘ç»“æœ
EOF
        
        if [ "${{ steps.compile_result.outputs.firmware_found }}" = "true" ] && [ -f "/tmp/firmware_list.txt" ]; then
          cat >> "$REPORT_DIR/report.md" << 'EOF'
### âœ… ç¼–è¯‘æˆåŠŸ
ç”Ÿæˆçš„å›ºä»¶æ–‡ä»¶:
EOF
          while read file; do
            echo "- $(basename "$file") ($(ls -lh "$file" | awk '{print $5}'))" >> "$REPORT_DIR/report.md"
          done < /tmp/firmware_list.txt
        else
          cat >> "$REPORT_DIR/report.md" << 'EOF'
### âŒ ç¼–è¯‘å¤±è´¥æˆ–æœªæ‰¾åˆ°å›ºä»¶
EOF
        fi
        
        # æ·»åŠ å¸¸è§é—®é¢˜è§£å†³æ–¹æ¡ˆ
        cat >> "$REPORT_DIR/report.md" << 'EOF'

## å¸¸è§é—®é¢˜è§£å†³æ–¹æ¡ˆ

### 1. ç½‘ç»œä¸‹è½½å¤±è´¥
