name: é€šç”¨OpenWrtç¼–è¯‘ï¼ˆæ™ºèƒ½ç£ç›˜ç®¡ç†ï¼‰

on:
  workflow_dispatch:
    inputs:
      compile_threads:
        description: 'ç¼–è¯‘çº¿ç¨‹æ•°'
        required: false
        default: '1'
        type: choice
        options:
          - '1'
          - '2'

env:
  REPO_URL: https://github.com/coolsnowwolf/lede
  BUILD_DIR: lede

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 360

    steps:
    - name: æ£€æŸ¥ä»£ç å’Œé…ç½®
      uses: actions/checkout@v4

    - name: è¶…æ·±åº¦ç£ç›˜ç©ºé—´ä¼˜åŒ–
      run: |
        echo "=== åˆå§‹ç£ç›˜ç©ºé—´ ==="
        df -h
        
        # è¶…æ·±åº¦æ¸…ç†ç³»ç»Ÿç©ºé—´
        echo "æ‰§è¡Œè¶…æ·±åº¦ç£ç›˜æ¸…ç†..."
        sudo apt-get remove --purge -y '^linux-.*[0-9]*-.*' 2>/dev/null || true
        sudo apt-get autoremove --purge -y
        sudo apt-get autoclean -y
        sudo rm -rf /var/lib/apt/lists/*
        
        # æ¸…ç†æ‰€æœ‰å¯èƒ½çš„ç¼“å­˜
        sudo rm -rf /var/cache/apt/archives/*
        sudo rm -rf /var/cache/debconf/*
        sudo rm -rf /var/cache/fontconfig/*
        
        # æ¸…ç†ç³»ç»Ÿæ—¥å¿—ï¼ˆä¿ç•™æœ€è¿‘1å°æ—¶ï¼‰
        sudo journalctl --vacuum-time=1h 2>/dev/null || true
        sudo find /var/log -name "*.log" -type f -delete 2>/dev/null || true
        sudo find /var/log -name "*.gz" -type f -delete 2>/dev/null || true
        
        # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
        sudo rm -rf /tmp/* /var/tmp/*
        
        # æ¸…ç†Dockerç›¸å…³ï¼ˆå¦‚æœæœ‰ï¼‰
        sudo docker system prune -af 2>/dev/null || true
        sudo rm -rf /var/lib/docker/* 2>/dev/null || true
        
        # æ¸…ç†å„ç§ç¼–ç¨‹è¯­è¨€ç¼“å­˜
        pip cache purge 2>/dev/null || true
        npm cache clean --force 2>/dev/null || true
        gem cleanup 2>/dev/null || true
        go clean -cache -modcache 2>/dev/null || true
        
        # åˆ›å»ºå¤§å®¹é‡äº¤æ¢æ–‡ä»¶
        echo "åˆ›å»ºå¤§å®¹é‡äº¤æ¢æ–‡ä»¶..."
        sudo swapoff -a 2>/dev/null || true
        sudo rm -f /swapfile* 2>/dev/null || true
        sudo dd if=/dev/zero of=/swapfile1 bs=1G count=2
        sudo dd if=/dev/zero of=/swapfile2 bs=1G count=2
        sudo chmod 600 /swapfile1 /swapfile2
        sudo mkswap /swapfile1
        sudo mkswap /swapfile2
        sudo swapon /swapfile1
        sudo swapon /swapfile2
        
        echo "=== ä¼˜åŒ–åç£ç›˜ç©ºé—´ ==="
        df -h
        echo "=== å†…å­˜å’Œäº¤æ¢ç©ºé—´ ==="
        free -h

    - name: éªŒè¯é…ç½®æ–‡ä»¶
      run: |
        if [ ! -f ".config" ]; then
          echo "âŒ é”™è¯¯ï¼šç¼ºå°‘é…ç½®æ–‡ä»¶ .config"
          echo "è¯·åœ¨å·¥ä½œæµè¿è¡Œå‰ä¸Šä¼  .config æ–‡ä»¶åˆ°ä»“åº“æ ¹ç›®å½•"
          exit 1
        fi
        echo "âœ… æ‰¾åˆ°é…ç½®æ–‡ä»¶"
        echo "=== é…ç½®æ–‡ä»¶é¢„è§ˆï¼ˆå‰30è¡Œï¼‰==="
        head -30 .config

    - name: å®‰è£…ç²¾ç®€ç¼–è¯‘ç¯å¢ƒ
      run: |
        echo "å®‰è£…ç²¾ç®€ç¼–è¯‘ç¯å¢ƒ..."
        sudo apt-get update
        
        # åªå®‰è£…æœ€å¿…è¦çš„ç¼–è¯‘å·¥å…·
        sudo apt-get install -y \
          build-essential \
          git \
          libncurses5-dev \
          libssl-dev \
          python3 \
          python3-pip \
          unzip \
          wget \
          curl \
          gcc \
          g++ \
          binutils \
          patch \
          bzip2 \
          flex \
          make \
          autoconf \
          automake \
          gettext \
          pkg-config \
          libtool \
          libc6-dev \
          m4 \
          gawk \
          sed \
          cmake \
          rsync \
          subversion \
          texinfo \
          zlib1g-dev

    - name: å…‹éš†æºç 
      run: |
        if [ -d "$BUILD_DIR" ]; then
          echo "åˆ é™¤å·²å­˜åœ¨çš„ $BUILD_DIR ç›®å½•"
          rm -rf "$BUILD_DIR"
        fi
        echo "å¼€å§‹å…‹éš†æºç ..."
        git clone --depth=1 --single-branch "$REPO_URL" "$BUILD_DIR"
        if [ $? -ne 0 ]; then
          echo "âŒ æºç å…‹éš†å¤±è´¥"
          exit 1
        fi
        echo "âœ… æºç å…‹éš†å®Œæˆ"

    - name: åº”ç”¨é…ç½®å’Œç²¾ç®€æºç 
      run: |
        if [ ! -d "$BUILD_DIR" ]; then
          echo "âŒ é”™è¯¯ï¼š$BUILD_DIR ç›®å½•ä¸å­˜åœ¨"
          exit 1
        fi
        
        cd "$BUILD_DIR"
        
        # åº”ç”¨é…ç½®æ–‡ä»¶
        if [ -f "../.config" ]; then
          cp "../.config" ".config"
          echo "âœ… é…ç½®æ–‡ä»¶å¤åˆ¶å®Œæˆ"
        else
          echo "âŒ é”™è¯¯ï¼šæœªæ‰¾åˆ°.configæ–‡ä»¶"
          exit 1
        fi
        
        # ç«‹å³ç²¾ç®€æºç 
        echo "ç«‹å³ç²¾ç®€æºç æ–‡ä»¶..."
        find . -name ".git" -type d -exec rm -rf {} + 2>/dev/null || true
        find . -name "*.md" -o -name "*.txt" -o -name "LICENSE" | head -200 | xargs rm -f 2>/dev/null || true
        find . -name "*test*" -type d | head -100 | xargs rm -rf 2>/dev/null || true
        find . -name "*.po" -o -name "*.pot" | head -100 | xargs rm -f 2>/dev/null || true
        
        # æ›´æ–°feedsï¼ˆç²¾ç®€ç‰ˆï¼‰
        ./scripts/feeds update -a
        ./scripts/feeds install -a
        
        # åº”ç”¨é…ç½®
        make defconfig
        
        echo "=== ç²¾ç®€åç£ç›˜ç©ºé—´ ==="
        df -h

    - name: æ™ºèƒ½ç¼–è¯‘ç®¡ç†ï¼ˆå¸¦æš‚åœæ¸…ç†åŠŸèƒ½ï¼‰
      run: |
        cd "$BUILD_DIR"
        THREADS=${{ github.event.inputs.compile_threads }}
        
        # ç£ç›˜ç›‘æ§å’Œæ™ºèƒ½æ¸…ç†å‡½æ•°
        start_disk_monitor() {
          while true; do
            AVAILABLE_SPACE=$(df / --output=avail | tail -1 | tr -d ' ')
            USAGE_PERCENT=$(df / --output=pcent | tail -1 | tr -d ' %')
            
            echo "ğŸ“Š ç£ç›˜ç›‘æ§: å¯ç”¨ ${AVAILABLE_SPACE}KB, ä½¿ç”¨ç‡ ${USAGE_PERCENT}%"
            
            # å¦‚æœä½¿ç”¨ç‡è¶…è¿‡85%ï¼Œè§¦å‘è½»åº¦æ¸…ç†
            if [ "$USAGE_PERCENT" -gt 85 ]; then
              echo "ğŸš¨ ç£ç›˜ä½¿ç”¨ç‡ ${USAGE_PERCENT}% > 85%ï¼Œæ‰§è¡Œè½»åº¦æ¸…ç†..."
              sudo apt-get clean
              sudo rm -rf /tmp/* /var/tmp/*
              find "$BUILD_DIR/build_dir" -name "*.o" -delete 2>/dev/null || true
              echo "è½»åº¦æ¸…ç†å®Œæˆ"
            fi
            
            # å¦‚æœä½¿ç”¨ç‡è¶…è¿‡92%ï¼Œè§¦å‘ä¸­åº¦æ¸…ç†å¹¶è­¦å‘Š
            if [ "$USAGE_PERCENT" -gt 92 ]; then
              echo "ğŸš¨ğŸš¨ ç£ç›˜ä½¿ç”¨ç‡ ${USAGE_PERCENT}% > 92%ï¼Œæ‰§è¡Œä¸­åº¦æ¸…ç†..."
              find "$BUILD_DIR/staging_dir" -name "*.a" -delete 2>/dev/null || true
              find "$BUILD_DIR/staging_dir" -name "*.la" -delete 2>/dev/null || true
              rm -rf "$BUILD_DIR/logs" 2>/dev/null || true
              echo "ä¸­åº¦æ¸…ç†å®Œæˆ"
            fi
            
            # å¦‚æœä½¿ç”¨ç‡è¶…è¿‡95%ï¼Œè§¦å‘ç´§æ€¥æš‚åœæ¸…ç†
            if [ "$USAGE_PERCENT" -gt 95 ]; then
              echo "ğŸš¨ğŸš¨ğŸš¨ ç´§æ€¥ï¼šç£ç›˜ä½¿ç”¨ç‡ ${USAGE_PERCENT}% > 95%ï¼Œæš‚åœç¼–è¯‘è¿›è¡Œæ·±åº¦æ¸…ç†ï¼"
              
              # æ€æ­»ç¼–è¯‘è¿›ç¨‹
              pkill -f "make.*-j$THREADS" 2>/dev/null || true
              sleep 2
              
              # æ‰§è¡Œæ·±åº¦æ¸…ç†
              echo "æ‰§è¡Œæ·±åº¦ç£ç›˜æ¸…ç†..."
              sudo docker system prune -af 2>/dev/null || true
              
              # æ¸…ç†ç¼–è¯‘ä¸­é—´æ–‡ä»¶
              find "$BUILD_DIR" -name "*.o" -delete 2>/dev/null || true
              find "$BUILD_DIR" -name "*.a" -delete 2>/dev/null || true
              find "$BUILD_DIR" -name "*.lo" -delete 2>/dev/null || true
              find "$BUILD_DIR" -name ".configured" -delete 2>/dev/null || true
              find "$BUILD_DIR" -name ".compiled" -delete 2>/dev/null || true
              
              # æ¸…ç†ä¸‹è½½ç¼“å­˜ï¼ˆå±é™©ä½†å¿…è¦ï¼‰
              if [ -d "$BUILD_DIR/dl" ]; then
                echo "æ¸…ç†ä¸‹è½½ç¼“å­˜..."
                find "$BUILD_DIR/dl" -name "*.tar.*" -type f | head -20 | xargs rm -f 2>/dev/null || true
              fi
              
              echo "æ·±åº¦æ¸…ç†å®Œæˆï¼Œå½“å‰ç£ç›˜ä½¿ç”¨ç‡: $(df / --output=pcent | tail -1)"
              echo "ğŸ”„ æ¸…ç†å®Œæˆï¼Œç¼–è¯‘å°†ç»§ç»­..."
            fi
            
            sleep 20
          done
        }
        
        # å¯åŠ¨ç£ç›˜ç›‘æ§
        start_disk_monitor &
        MONITOR_PID=$!
        
        # ç¡®ä¿ç›‘æ§è¿›ç¨‹åœ¨è„šæœ¬é€€å‡ºæ—¶è¢«æ¸…ç†
        trap "kill $MONITOR_PID 2>/dev/null || true; exit" EXIT INT TERM
        
        echo "å¼€å§‹æ™ºèƒ½ç¼–è¯‘..."
        echo "=== ç¼–è¯‘å‰ç£ç›˜ç©ºé—´ ==="
        df -h
        
        # ä¸‹è½½è½¯ä»¶åŒ…
        echo "ä¸‹è½½è½¯ä»¶åŒ…..."
        make download -j$THREADS || echo "ä¸‹è½½å¤±è´¥ï¼Œä½†ç»§ç»­å°è¯•ç¼–è¯‘..."
        
        # åˆ†æ­¥ç¼–è¯‘å‡½æ•°ï¼ˆå¸¦é‡è¯•å’Œç£ç›˜æ£€æŸ¥ï¼‰
        compile_step() {
          local step=$1
          local max_attempts=2
          
          for attempt in $(seq 1 $max_attempts); do
            echo "æ‰§è¡Œ: $step (å°è¯• $attempt/$max_attempts)"
            
            # æ‰§è¡Œç¼–è¯‘å‰æ£€æŸ¥ç£ç›˜
            check_disk_before_compile
            
            if make $step -j$THREADS; then
              echo "âœ… $step å®Œæˆ"
              # æ­¥éª¤å®Œæˆåç«‹å³æ¸…ç†
              cleanup_after_step "$step"
              return 0
            else
              echo "âŒ $step ç¬¬ $attempt æ¬¡å°è¯•å¤±è´¥"
              if [ $attempt -eq $max_attempts ]; then
                echo "å°è¯•å•çº¿ç¨‹è¯¦ç»†æ¨¡å¼..."
                make $step -j1 V=s
                cleanup_after_step "$step"
                return $?
              fi
              sleep 10
            fi
          done
          return 1
        }
        
        # ç¼–è¯‘å‰ç£ç›˜æ£€æŸ¥
        check_disk_before_compile() {
          local available=$(df / --output=avail | tail -1 | tr -d ' ')
          if [ "$available" -lt 2097152 ]; then  # å°äº2GB
            echo "âš ï¸ ç¼–è¯‘å‰ç£ç›˜æ£€æŸ¥: ç©ºé—´ä¸è¶³ï¼Œæ‰§è¡Œé¢„æ¸…ç†..."
            sudo apt-get clean
            find "$BUILD_DIR/build_dir" -name "*.o" -delete 2>/dev/null || true
          fi
        }
        
        # æ­¥éª¤å®Œæˆåæ¸…ç†
        cleanup_after_step() {
          local step=$1
          echo "æ¸…ç† $step çš„ä¸­é—´æ–‡ä»¶..."
          find "$BUILD_DIR/build_dir" -name "*.o" -delete 2>/dev/null || true
          find "$BUILD_DIR/build_dir" -name "*.a" -delete 2>/dev/null || true
          find "$BUILD_DIR/staging_dir" -name "*.a" -delete 2>/dev/null || true
        }
        
        # æ‰§è¡Œåˆ†æ­¥ç¼–è¯‘
        COMPILE_STEPS=(
          "tools/compile"
          "toolchain/compile" 
          "target/compile"
          "package/compile"
          "package/index"
        )
        
        for step in "${COMPILE_STEPS[@]}"; do
          echo "========================================"
          echo "ç¼–è¯‘æ­¥éª¤: $step"
          echo "å½“å‰ç£ç›˜: $(df -h / | tail -1)"
          echo "========================================"
          
          if ! compile_step "$step"; then
            echo "âš ï¸ $step æ­¥éª¤ç¼–è¯‘æœ‰é—®é¢˜ï¼Œä½†ç»§ç»­ä¸‹ä¸€ä¸ªæ­¥éª¤..."
          fi
          
          # æ­¥éª¤é—´æš‚åœï¼Œè®©ç›‘æ§æœ‰æœºä¼šè¿è¡Œ
          sleep 5
        done
        
        # åœæ­¢ç›‘æ§
        kill $MONITOR_PID 2>/dev/null || true
        
        echo "ğŸ‰ åˆ†æ­¥ç¼–è¯‘å®Œæˆ"

    - name: æœ€ç»ˆç¼–è¯‘
      run: |
        cd "$BUILD_DIR"
        THREADS=${{ github.event.inputs.compile_threads }}
        
        echo "æ‰§è¡Œæœ€ç»ˆç¼–è¯‘..."
        echo "=== æœ€ç»ˆç¼–è¯‘å‰ç£ç›˜ç©ºé—´ ==="
        df -h
        
        # æœ€ç»ˆç¼–è¯‘å‰ç´§æ€¥æ£€æŸ¥
        AVAILABLE_SPACE=$(df / --output=avail | tail -1 | tr -d ' ')
        if [ "$AVAILABLE_SPACE" -lt 1572864 ]; then  # å°äº1.5GB
          echo "ğŸš¨ æœ€ç»ˆç¼–è¯‘å‰ç©ºé—´ä¸è¶³ï¼Œæ‰§è¡Œç´§æ€¥æ¸…ç†..."
          sudo rm -rf /tmp/* /var/tmp/*
          find "$BUILD_DIR" -name "*.o" -delete 2>/dev/null || true
          find "$BUILD_DIR" -name "*.a" -delete 2>/dev/null || true
        fi
        
        if make -j$THREADS; then
          echo "ğŸ‰ ç¼–è¯‘æˆåŠŸï¼"
        else
          echo "âŒ æœ€ç»ˆç¼–è¯‘å¤±è´¥ï¼Œå°è¯•å•çº¿ç¨‹ç¼–è¯‘..."
          make -j1 V=s
        fi

    - name: æ£€æŸ¥ç”Ÿæˆçš„æ–‡ä»¶
      run: |
        if [ ! -d "$BUILD_DIR" ]; then
          echo "âŒ é”™è¯¯ï¼š$BUILD_DIR ç›®å½•ä¸å­˜åœ¨"
          exit 1
        fi
        
        echo "ğŸ” æ£€æŸ¥ç”Ÿæˆçš„å›ºä»¶..."
        FIRMWARE_FILES=$(find "$BUILD_DIR/bin" -type f \( -name "*.bin" -o -name "*.img" -o -name "*.gz" \) 2>/dev/null || true)
        
        if [ -n "$FIRMWARE_FILES" ]; then
          echo "âœ… æ‰¾åˆ°å›ºä»¶æ–‡ä»¶:"
          echo "$FIRMWARE_FILES"
          echo "æ–‡ä»¶å¤§å°ç»Ÿè®¡:"
          du -sh "$BUILD_DIR/bin/" 2>/dev/null || true
        else
          echo "âŒ æœªæ‰¾åˆ°å›ºä»¶æ–‡ä»¶"
          exit 1
        fi
        
        echo "=== æœ€ç»ˆç£ç›˜ç©ºé—´ ==="
        df -h

    - name: ä¸Šä¼ å›ºä»¶æ–‡ä»¶
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: openwrt-firmware
        path: ${{ env.BUILD_DIR }}/bin/
        retention-days: 30

    - name: å®Œæˆæç¤º
      if: always()
      run: |
        if [ "${{ job.status }}" == "success" ]; then
          echo "ğŸŠ ç¼–è¯‘æˆåŠŸå®Œæˆï¼"
          echo "ğŸ“¥ å›ºä»¶æ–‡ä»¶å¯åœ¨ArtifactsåŒºåŸŸä¸‹è½½"
        else
          echo "âŒ ç¼–è¯‘å¤±è´¥"
          echo "ğŸ’¡ å»ºè®®ï¼šå°è¯•ä½¿ç”¨æ›´ç²¾ç®€çš„.configé…ç½®æˆ–å‡å°‘ç¼–è¯‘åŒ…æ•°é‡"
        fi
