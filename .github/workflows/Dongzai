name: æ ‹ä»”ä¸»é¢˜ç¼–è¯‘

on:
  workflow_dispatch:
  push:
    branches: [ main ]

env:
  REPO_URL: https://github.com/coolsnowwolf/lede

jobs:
  build:
    runs-on: ubuntu-20.04
    timeout-minutes: 240

    steps:
    - name: æ£€æŸ¥ä»£ç å’Œé…ç½®
      uses: actions/checkout@v4

    - name: éªŒè¯é…ç½®æ–‡ä»¶
      run: |
        echo "=== æ£€æŸ¥å¿…è¦æ–‡ä»¶ ==="
        if [ -f ".config" ]; then
          echo "âœ… æ‰¾åˆ° .config æ–‡ä»¶"
          echo "é…ç½®æ–‡ä»¶å†…å®¹:"
          cat .config
        else
          echo "âŒ é”™è¯¯ï¼šç¼ºå°‘ .config æ–‡ä»¶"
          echo "è¯·åœ¨ä»“åº“æ ¹ç›®å½•åˆ›å»º .config æ–‡ä»¶"
          exit 1
        fi
        
        if [ -d ".github/themes/dongzhai" ]; then
          echo "âœ… æ‰¾åˆ°ä¸»é¢˜æ–‡ä»¶"
        else
          echo "âŒ é”™è¯¯ï¼šç¼ºå°‘ä¸»é¢˜æ–‡ä»¶"
          echo "è¯·åˆ›å»º .github/themes/dongzhai/ ç›®å½•ç»“æ„"
          exit 1
        fi

    - name: åˆå§‹åŒ–ç¯å¢ƒ
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential git libncurses5-dev libssl-dev python2.7 python3 unzip wget curl
        python2.7 --version
        echo "âœ… ç¯å¢ƒåˆå§‹åŒ–å®Œæˆ"

    - name: å…‹éš†Leanæºç 
      run: |
        echo "å…‹éš† Lean OpenWrt æºç ..."
        git clone $REPO_URL lede
        echo "âœ… æºç å…‹éš†å®Œæˆ"

    - name: å‡†å¤‡ç¼–è¯‘ç¯å¢ƒ
      run: |
        cd lede
        ./scripts/feeds update -a
        ./scripts/feeds install -a
        echo "âœ… ç¯å¢ƒå‡†å¤‡å®Œæˆ"

    - name: éƒ¨ç½²æ ‹ä»”ä¸»é¢˜
      run: |
        cd lede
        echo "å¼€å§‹éƒ¨ç½²æ ‹ä»”ä¸ªæ€§åŒ–è®¾ç½®..."
        
        # åˆ›å»ºä¸»é¢˜ç›®å½•
        mkdir -p package/lean/dongzhai-theme/luci-theme-dongzhai
        
        # å¤åˆ¶ä¸»é¢˜æ–‡ä»¶
        if [ -d "../.github/themes/dongzhai" ]; then
          echo "å¤åˆ¶æ ‹ä»”ä¸»é¢˜æ–‡ä»¶..."
          cp -r ../.github/themes/dongzhai/* package/lean/dongzhai-theme/
          echo "âœ… ä¸»é¢˜æ–‡ä»¶å¤åˆ¶å®Œæˆ"
        else
          echo "âš ï¸ æœªæ‰¾åˆ°ä¸»é¢˜æ–‡ä»¶ï¼Œä½¿ç”¨åŸºç¡€æ¨¡æ¿"
        fi
        
        # åˆ›å»ºä¸»é¢˜çš„Makefile
        cat > package/lean/dongzhai-theme/luci-theme-dongzhai/Makefile << 'EOF'
include $(TOPDIR)/rules.mk

LUCI_TITLE:=æ ‹ä»”ä¸ªæ€§åŒ–ä¸»é¢˜
LUCI_DEPENDS:=
PKG_VERSION:=1.0
PKG_RELEASE:=1

include $(INCLUDE_DIR)/package.mk

define Package/luci-theme-dongzhai
  $(call Package/luci/webtemplate)
  TITLE:=æ ‹ä»”ä¸ªæ€§åŒ–ä¸»é¢˜
  DEPENDS:=+luci-compat
endef

define Package/luci-theme-dongzhai/description
  æ ‹ä»”ä¸ªæ€§åŒ–ä¸»é¢˜
endef

define Build/Configure
endef

define Build/Compile
endef

define Package/luci-theme-dongzhai/install
	$(INSTALL_DIR) $(1)/www/luci-static/dongzhai
	[ -d ./files ] && $(CP) ./files/* $(1)/www/luci-static/dongzhai/
endef

$(eval $(call BuildPackage,luci-theme-dongzhai))
EOF

        echo "âœ… æ ‹ä»”ä¸»é¢˜éƒ¨ç½²å®Œæˆ"

    - name: é…ç½®ç¼–è¯‘é€‰é¡¹
      run: |
        cd lede
        echo "åº”ç”¨é…ç½®æ–‡ä»¶..."
        cp ../.config .config
        
        echo "æ·»åŠ æ ‹ä»”ä¸»é¢˜é…ç½®..."
        echo "CONFIG_PACKAGE_luci-theme-dongzhai=y" >> .config
        echo "CONFIG_DEFAULT_luci-theme-dongzhai=y" >> .config
        
        make defconfig
        echo "âœ… é…ç½®å®Œæˆ"

    - name: ä¸‹è½½è½¯ä»¶åŒ…
      run: |
        cd lede
        echo "å¼€å§‹ä¸‹è½½è½¯ä»¶åŒ…..."
        make download -j2
        echo "âœ… è½¯ä»¶åŒ…ä¸‹è½½å®Œæˆ"

    - name: ç¼–è¯‘å›ºä»¶
      run: |
        cd lede
        echo "å¼€å§‹ç¼–è¯‘å›ºä»¶..."
        echo "è¿™å¯èƒ½éœ€è¦2-4å°æ—¶ï¼Œè¯·è€å¿ƒç­‰å¾…..."
        make -j2
        echo "âœ… ç¼–è¯‘å®Œæˆ"

    - name: æ£€æŸ¥ç¼–è¯‘ç»“æœ
      run: |
        cd lede/bin/targets
        echo "=== æŸ¥æ‰¾ç”Ÿæˆçš„å›ºä»¶ ==="
        find . -name "*.bin" -type f
        echo "âœ… ç»“æœæ£€æŸ¥å®Œæˆ"

    - name: ä¸Šä¼ å›ºä»¶
      uses: actions/upload-artifact@v4
      with:
        name: æ ‹ä»”ä¸»é¢˜å›ºä»¶
        path: lede/bin/targets/**/*.bin
        retention-days: 7

    - name: ç¼–è¯‘æˆåŠŸé€šçŸ¥
      if: success()
      run: |
        echo "ğŸ‰ ç¼–è¯‘æˆåŠŸå®Œæˆï¼"
        echo "ğŸ“¦ å›ºä»¶å·²ä¸Šä¼ åˆ° Artifacts"
        echo "â° æ€»ç¼–è¯‘æ—¶é—´: çº¦2-4å°æ—¶"
