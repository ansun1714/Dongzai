name: ğŸ  æ ‹ä»”ä¸»é¢˜ä¸ªæ€§åŒ–å›ºä»¶ç¼–è¯‘

on:
  workflow_dispatch:
    inputs:
      clean_build:
        description: 'æ˜¯å¦æ¸…ç†é‡æ–°ç¼–è¯‘'
        required: false
        default: false
        type: boolean
      compile_threads:
        description: 'ç¼–è¯‘çº¿ç¨‹æ•° (æ¨è1-2)'
        required: false
        default: 1
        type: choice
        options:
        - 1
        - 2

env:
  REPO_URL: https://github.com/coolsnowwolf/lede
  BUILD_DIR: lede

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 360

    steps:
    - name: ğŸ“‹ åˆå§‹åŒ–æ£€æŸ¥
      uses: actions/checkout@v4

    - name: ğŸ” éªŒè¯é…ç½®æ–‡ä»¶
      run: |
        echo "=== é…ç½®æ–‡ä»¶éªŒè¯ ==="
        if [ ! -f ".config" ]; then
          echo "âŒ é”™è¯¯ï¼šæœªæ‰¾åˆ° .config æ–‡ä»¶"
          exit 1
        fi
        echo "âœ… æ‰¾åˆ°é…ç½®æ–‡ä»¶"

    - name: ğŸ› ï¸ å®‰è£…ç¼–è¯‘ç¯å¢ƒ
      run: |
        echo "=== å®‰è£…ç¼–è¯‘å·¥å…·é“¾ ==="
        sudo apt-get update
        sudo apt-get install -y build-essential git libncurses5-dev libssl-dev python3 unzip wget curl
        echo "âœ… ç¯å¢ƒå®‰è£…å®Œæˆ"

    - name: ğŸ“¥ å…‹éš†Leanæºç 
      run: |
        echo "=== å…‹éš†OpenWrtæºç  ==="
        if [ -d "$BUILD_DIR" ] && [ "${{ github.event.inputs.clean_build }}" = "true" ]; then
          echo "æ¸…ç†æ—§ç¼–è¯‘ç›®å½•..."
          rm -rf $BUILD_DIR
        fi
        
        if [ ! -d "$BUILD_DIR" ]; then
          git clone --depth 1 $REPO_URL $BUILD_DIR
          echo "âœ… æºç å…‹éš†å®Œæˆ"
        else
          echo "âœ… ä½¿ç”¨ç°æœ‰æºç ç›®å½•"
        fi

    - name: ğŸ”„ æ›´æ–°è½¯ä»¶æº
      run: |
        cd $BUILD_DIR
        echo "=== æ›´æ–°è½¯ä»¶æºå’ŒåŒ… ==="
        ./scripts/feeds update -a
        ./scripts/feeds install -a
        echo "âœ… è½¯ä»¶æºæ›´æ–°å®Œæˆ"

    - name: ğŸš« å½»åº•å¤„ç†Node.jsé—®é¢˜
      run: |
        cd $BUILD_DIR
        echo "=== å½»åº•å¤„ç†Node.jsç¼–è¯‘é—®é¢˜ ==="
        
        # ä»feedsä¸­ç§»é™¤nodeåŒ…
        if [ -d "feeds/packages/lang/node" ]; then
          rm -rf feeds/packages/lang/node
          echo "âœ… ç§»é™¤ feeds/packages/lang/node"
        fi
        
        # åˆ›å»ºç©ºçš„nodeç›®å½•é¿å…é”™è¯¯
        mkdir -p feeds/packages/lang/node
        touch feeds/packages/lang/node/Makefile
        echo "âœ… åˆ›å»ºç©ºNode.jsç›®å½•é¿å…ä¾èµ–é”™è¯¯"

    - name: ğŸ¨ éƒ¨ç½²æ ‹ä»”ä¸»é¢˜
      run: |
        cd $BUILD_DIR
        echo "=== éƒ¨ç½²ä¸ªæ€§åŒ–ä¸»é¢˜ ==="
        
        THEME_DIR="package/lean/dongzhai-theme/luci-theme-dongzhai"
        mkdir -p $THEME_DIR/files/www/luci-static/dongzhai/css
        
        # åˆ›å»ºä¸»é¢˜Makefile
        cat > $THEME_DIR/Makefile << 'EOF'
include $(TOPDIR)/rules.mk

LUCI_TITLE:=æ ‹ä»”ä¸ªæ€§åŒ–ä¸»é¢˜
LUCI_DEPENDS:=
PKG_VERSION:=1.0
PKG_RELEASE:=1

include $(INCLUDE_DIR)/package.mk

define Package/luci-theme-dongzhai
  $(call Package/luci/webtemplate)
  TITLE:=æ ‹ä»”ä¸ªæ€§åŒ–ä¸»é¢˜
  DEPENDS:=+luci-compat
endef

define Package/luci-theme-dongzhai/description
  æ ‹ä»”ä¸ªæ€§åŒ–ä¸»é¢˜
endef

define Build/Configure
endef

define Build/Compile
endef

define Package/luci-theme-dongzhai/install
	$(INSTALL_DIR) $(1)/www/luci-static/dongzhai
	[ -d ./files ] && $(CP) ./files/* $(1)/www/luci-static/dongzhai/
endef

$(eval $(call BuildPackage,luci-theme-dongzhai))
EOF

        # åˆ›å»ºä¸»é¢˜æ ·å¼æ–‡ä»¶
        cat > $THEME_DIR/files/www/luci-static/dongzhai/css/style.css << 'EOF'
/* æ ‹ä»”ä¸ªæ€§åŒ–ä¸»é¢˜æ ·å¼ */
.header .fill .brand {
    color: #ff6600;
    font-weight: bold;
    font-size: 18px;
}

.sidebar {
    background: #2c3e50;
}

.sidebar .nav > li > a {
    color: #ecf0f1;
}

.btn-primary {
    background-color: #ff6600;
    border-color: #ff6600;
}
EOF

        echo "âœ… æ ‹ä»”ä¸»é¢˜éƒ¨ç½²å®Œæˆ"

    - name: âš™ï¸ åº”ç”¨ç¼–è¯‘é…ç½®
      run: |
        cd $BUILD_DIR
        echo "=== åº”ç”¨ç¼–è¯‘é…ç½® ==="
        
        # å¤åˆ¶ç”¨æˆ·é…ç½®æ–‡ä»¶
        cp ../.config .config
        
        # å½»åº•ç¦ç”¨Node.js
        echo "# CONFIG_PACKAGE_node is not set" >> .config
        echo "# CONFIG_PACKAGE_node-npm is not set" >> .config
        echo "# CONFIG_PACKAGE_node-yarn is not set" >> .config
        
        # ç¡®ä¿æ ‹ä»”ä¸»é¢˜é…ç½®
        echo "CONFIG_PACKAGE_luci-theme-dongzhai=y" >> .config
        echo "CONFIG_DEFAULT_luci-theme-dongzhai=y" >> .config
        
        make defconfig
        echo "âœ… é…ç½®åº”ç”¨å®Œæˆ"

    - name: ğŸ“¦ ä¸‹è½½è½¯ä»¶åŒ…
      run: |
        cd $BUILD_DIR
        echo "=== ä¸‹è½½ä¾èµ–è½¯ä»¶åŒ… ==="
        
        THREADS=${{ github.event.inputs.compile_threads || 1 }}
        make download -j$THREADS
        echo "âœ… è½¯ä»¶åŒ…ä¸‹è½½å®Œæˆ"

    - name: ğŸ”¨ ç¼–è¯‘å›ºä»¶
      run: |
        cd $BUILD_DIR
        echo "=== å¼€å§‹ç¼–è¯‘å›ºä»¶ ==="
        
        THREADS=${{ github.event.inputs.compile_threads || 1 }}
        echo "ä½¿ç”¨ $THREADS ä¸ªçº¿ç¨‹ç¼–è¯‘..."
        
        start_time=$(date +%s)
        echo "ç¼–è¯‘å¼€å§‹æ—¶é—´: $(date)"
        
        if [ "$THREADS" = "1" ]; then
          make -j1 V=s
        else
          make -j$THREADS
        fi
        
        end_time=$(date +%s)
        duration=$((end_time - start_time))
        hours=$((duration / 3600))
        minutes=$(( (duration % 3600) / 60 ))
        seconds=$((duration % 60))
        
        echo "âœ… ç¼–è¯‘å®Œæˆ!"
        echo "æ€»ç¼–è¯‘æ—¶é—´: ${hours}å°æ—¶ ${minutes}åˆ†é’Ÿ ${seconds}ç§’"

    - name: ğŸ“¤ æ”¶é›†ç¼–è¯‘ç»“æœ
      id: collect_firmware
      run: |
        cd $BUILD_DIR/bin/targets
        echo "=== æ”¶é›†ç¼–è¯‘ç»“æœ ==="
        
        FIRMWARE_FILES=$(find . -name "*.bin" -type f)
        
        if [ -n "$FIRMWARE_FILES" ]; then
          echo "ğŸ‰ æ‰¾åˆ°å›ºä»¶æ–‡ä»¶:"
          for file in $FIRMWARE_FILES; do
            if [ -f "$file" ]; then
              size=$(du -h "$file" | cut -f1)
              echo "  $file ($size)"
            fi
          done
          
          FIRST_FILE=$(echo "$FIRMWARE_FILES" | head -1)
          DEVICE_INFO=$(echo "$FIRMWARE_FILES" | head -1 | grep -o 'targets/[^/]*/[^/]*' | cut -d'/' -f2-3 | tr '/' '_')
          
          echo "has_firmware=true" >> $GITHUB_OUTPUT
          echo "firmware_count=$(echo "$FIRMWARE_FILES" | wc -w)" >> $GITHUB_OUTPUT
          echo "device_info=$DEVICE_INFO" >> $GITHUB_ENV
          
        else
          echo "âŒ æœªæ‰¾åˆ°å›ºä»¶æ–‡ä»¶!"
          echo "has_firmware=false" >> $GITHUB_OUTPUT
        fi

    - name: ğŸ“ ä¸Šä¼ å›ºä»¶åˆ°Artifacts
      if: steps.collect_firmware.outputs.has_firmware == 'true'
      uses: actions/upload-artifact@v4
      with:
        name: æ ‹ä»”å›ºä»¶_${{ env.device_info }}
        path: ${{ env.BUILD_DIR }}/bin/targets/**/*.bin
        retention-days: 30

    - name: ğŸš€ åˆ›å»ºç‰ˆæœ¬å‘å¸ƒ
      if: steps.collect_firmware.outputs.has_firmware == 'true'
      uses: softprops/action-gh-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: dongzhai-${{ env.device_info }}-$(date +%Y%m%d)
        name: æ ‹ä»”ä¸»é¢˜å›ºä»¶ - ${{ env.device_info }}
        body: |
          # æ ‹ä»”ä¸»é¢˜ä¸ªæ€§åŒ–å›ºä»¶
          
          ## ç¼–è¯‘ä¿¡æ¯
          - **è®¾å¤‡å¹³å°**: ${{ env.device_info }}
          - **ç¼–è¯‘æ—¶é—´**: $(date)
          - **æºç ç‰ˆæœ¬**: Lean's OpenWrt
          
          ## ä¸»é¢˜ç‰¹è‰²
          - æ ‹ä»”ä¸ªæ€§åŒ–ä¸»é¢˜ç•Œé¢
          - å½»åº•ç¦ç”¨Node.jsç¡®ä¿ç¼–è¯‘æˆåŠŸ
          
          ## åˆ·æœºè¯´æ˜
          1. é¦–æ¬¡åˆ·æœºä½¿ç”¨ factory.bin æ–‡ä»¶
          2. ç³»ç»Ÿå‡çº§ä½¿ç”¨ sysupgrade.bin æ–‡ä»¶
          3. åˆ·æœºå‰è¯·å¤‡ä»½é‡è¦é…ç½®
        files: ${{ env.BUILD_DIR }}/bin/targets/**/*.bin
        draft: false
        prerelease: false

    - name: ğŸ“Š ç¼–è¯‘æ€»ç»“æŠ¥å‘Š
      if: always()
      run: |
        echo ""
        echo "================================================"
        echo "              ç¼–è¯‘ä»»åŠ¡å®ŒæˆæŠ¥å‘Š"
        echo "================================================"
        
        if [ "${{ success() }}" = "true" ]; then
          if [ "${{ steps.collect_firmware.outputs.has_firmware }}" = "true" ]; then
            echo "âœ… ç¼–è¯‘æˆåŠŸ!"
            echo "å›ºä»¶æ•°é‡: ${{ steps.collect_firmware.outputs.firmware_count }} ä¸ª"
            echo "è®¾å¤‡å¹³å°: ${{ env.device_info }}"
            echo "ä¸‹è½½ä½ç½®: Actions â†’ Artifacts"
          else
            echo "âš ï¸ ç¼–è¯‘å®Œæˆä½†æœªç”Ÿæˆå›ºä»¶æ–‡ä»¶"
          fi
        else
            echo "âŒ ç¼–è¯‘å¤±è´¥!"
        fi
        echo "================================================"
